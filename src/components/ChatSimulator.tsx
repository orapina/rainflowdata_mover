'use client'

import { useState, useRef, useEffect, useMemo } from 'react'
import {
  COUNTRIES, GOALS, OCCUPATIONS,
  CURRENCY_TO_THB, CURRENCY_SYMBOLS,
  matchCountries,
  type MatchResult, type MatchParams,
} from '@/data/country-data'
import {
  AUD_TO_THB, calculateAusTax, calculateThaiTax,
  AU_SALARIES, AU_UNSKILLED_SALARY, TH_TOTAL_LIVING,
  AU_CITIES, FOOD_COSTS, TRANSPORT_COSTS,
  calculateSimpleVisaScore,
} from '@/data/simulator-data'
import { searchOccupations } from '@/data/occupations'
import { getCountryDetails, type OccupationSalaries, type SalaryRange } from '@/data/country-detailed-data'
import {
  chatWithGroq, analyzeResults, rankCountriesWithAI,
  getStoredApiKey,
  type ChatMessage, type GatheredData,
} from '@/lib/groq'
import { ShareButtons } from './ShareButtons'

const basePath = process.env.NEXT_PUBLIC_BASE_PATH || ''

// ===== TYPES =====
type Phase = 'welcome' | 'quiz' | 'aiChat' | 'analyzing' | 'countryResults' | 'auProfile' | 'sim' | 'result'

interface QuickProfile {
  age: string
  monthlyIncome: string
  savings: string
  family: string
}

interface AuProfile {
  english: string
  experience: string
  education: string
  thaiSalary: string
  city: string
}

// ===== CONSTANTS =====
const fmt = (n: number) => Math.round(n).toLocaleString()
const fmtAud = (n: number) => `$${fmt(n)}`
const fmtThb = (n: number) => `‡∏ø${fmt(n)}`

// Map user occupation ID ‚Üí key in OccupationSalaries
const OCC_TO_SALARY_KEY: Record<string, keyof OccupationSalaries> = {
  'software': 'softwareDev',
  'engineering': 'engineer',
  'accounting': 'accountant',
  'healthcare': 'nurse',
  'chef': 'trades', // chef uses trades salary range as closest proxy
  'other': 'trades',
}

function getOccSalary(countryId: string, occId: string): SalaryRange | null {
  const details = getCountryDetails(countryId)
  if (!details) return null
  const key = OCC_TO_SALARY_KEY[occId] || 'softwareDev'
  return details.salaries[key] || null
}

const STAGE_META = [
  { id: 'savings', title: 'üí∞ ‡∏î‡πà‡∏≤‡∏ô 1: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏£‡∏∞‡∏™‡∏∏‡∏ô', sub: '‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?' },
  { id: 'predeparture', title: 'üìã ‡∏î‡πà‡∏≤‡∏ô 2: ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏¥‡∏ô', sub: '‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?' },
  { id: 'job', title: 'üíº ‡∏î‡πà‡∏≤‡∏ô 3: ‡πÑ‡∏î‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!', sub: '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?' },
  { id: 'flight', title: '‚úàÔ∏è ‡∏î‡πà‡∏≤‡∏ô 4: ‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡∏±‡πã‡∏ß‡∏ö‡∏¥‡∏ô‡∏Å‡∏±‡∏ô!', sub: 'Business ‡∏´‡∏£‡∏∑‡∏≠ Economy?' },
  { id: 'temp', title: 'üõ¨ ‡∏î‡πà‡∏≤‡∏ô 5: ‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß! ‡∏û‡∏±‡∏Å‡πÑ‡∏´‡∏ô‡∏Å‡πà‡∏≠‡∏ô?', sub: '‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ä‡πà‡∏ß‡∏á 2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÅ‡∏£‡∏Å' },
  { id: 'housing', title: 'üè† ‡∏î‡πà‡∏≤‡∏ô 6: ‡∏´‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÜ!', sub: '‡πÅ‡∏ä‡∏£‡πå‡∏´‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß?' },
  { id: 'furnish', title: 'üõãÔ∏è ‡∏î‡πà‡∏≤‡∏ô 7: ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô', sub: '‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÑ‡∏´‡∏ô?' },
  { id: 'commute', title: 'üöó ‡∏î‡πà‡∏≤‡∏ô 8: ‡πÑ‡∏õ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á', sub: '‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏ñ‡πÑ‡∏ü?' },
  { id: 'food', title: 'üç≥ ‡∏î‡πà‡∏≤‡∏ô 9: ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡∏¢‡∏±‡∏á‡πÑ‡∏á', sub: '‡∏ó‡∏≥‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏¥‡∏ô?' },
  { id: 'insurance', title: 'üè• ‡∏î‡πà‡∏≤‡∏ô 10: ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û', sub: '‡∏à‡∏±‡∏î‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ Medicare ‡∏ü‡∏£‡∏µ?' },
]
const TOTAL_STAGES = STAGE_META.length

// ===== AI SYSTEM PROMPT =====
const AI_SYSTEM_PROMPT = `‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏∑‡πà‡∏≠ "Catto" üê± ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® (14 ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Ñ‡πà‡∏≠‡∏≠‡∏™‡πÄ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢) ‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ emoji ‡∏û‡∏≠‡∏î‡∏µ

‚õî GUARDRAILS ‚Äî ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î:
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢+‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‚Äî ‡∏´‡πâ‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô ‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô ‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏≠‡∏∑‡πà‡∏ô
- ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å: ‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®, ‡∏ß‡∏µ‡∏ã‡πà‡∏≤, ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡∏ä‡∏µ‡∏û, ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û/‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï, ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
- ‡∏ñ‡πâ‡∏≤ user ‡∏ñ‡∏≤‡∏°‡∏ô‡∏≠‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å, ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô, coding, ‡∏Ø‡∏•‡∏Ø) ‚Üí ‡∏ï‡∏≠‡∏ö: "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ Catto ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏∞ üò∏ ‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!"
- ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 80 ‡∏Ñ‡∏≥) ‚Äî ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠
- ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏´‡πâ‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏¢‡∏∑‡∏î‡∏¢‡∏≤‡∏ß ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏à‡∏Å‡πÅ‡∏à‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠
- ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πá‡∏à ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "Catto ‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏ß‡∏£‡πå ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏∞"
- ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏™‡∏£‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô migration agent ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢

‡∏Å‡∏é‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:
1. ‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà user ‡∏û‡∏π‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÜ ‚Äî ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡∏≤‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡∏Å‡πá‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Ñ‡πà‡∏û‡∏π‡∏î‡∏ß‡πà‡∏≤ "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à!"
2. ‡∏ñ‡πâ‡∏≤ user ‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÄ‡∏â‡∏û‡∏≤‡∏∞ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏¢‡∏≠‡∏£‡∏°‡∏±‡∏ô, ‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤) ‡πÉ‡∏´‡πâ acknowledge ‡πÄ‡∏ä‡πà‡∏ô "‡πÄ‡∏¢‡∏≠‡∏£‡∏°‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÄ‡∏´‡∏£‡∏≠ ‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à!"
3. ‡∏ñ‡πâ‡∏≤ user ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á (work-life balance, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô, ‡∏Ø‡∏•‡∏Ø) ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ 1-2 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
4. ‡∏´‡πâ‡∏≤‡∏°‡∏û‡∏π‡∏î "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß! üí™" ‡∏ã‡πâ‡∏≥‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‚Äî ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô ‡πÄ‡∏ä‡πà‡∏ô "‡∏ß‡πâ‡∏≤‡∏ß ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏•‡∏¢‡πÄ‡∏´‡∏£‡∏≠", "‡πÇ‡∏´ ‡πÄ‡∏¢‡∏≠‡∏£‡∏°‡∏±‡∏ô‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏°‡∏≤‡∏Å", "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÇ‡∏≠‡πÄ‡∏Ñ‡πÄ‡∏•‡∏¢"
5. ‡∏ñ‡πâ‡∏≤ user ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û + ‡∏≠‡∏≤‡∏¢‡∏∏ + ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®) ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏ã‡πâ‡∏≥
6. ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô 1-3 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡∏à‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° 1 ‡∏Ç‡πâ‡∏≠
7. ‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô

Flow:
1. ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏£‡∏Å: ‡πÉ‡∏´‡πâ user ‡πÄ‡∏•‡πà‡∏≤‡∏≠‡∏¥‡∏™‡∏£‡∏∞
2. ‡∏´‡∏•‡∏±‡∏á user ‡πÄ‡∏•‡πà‡∏≤: ‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÜ + ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ + ‡∏ñ‡∏≤‡∏° "‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÑ‡∏´‡∏°?"
3. ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î ‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡πÑ‡∏î‡πâ):
   - goals (1-3): money-job | balance | family | stable | lifestyle
   - occupation: software | engineering | accounting | healthcare | chef | other
   - age: "18-24" | "25-32" | "33-39" | "40-44" | "45+"
   - family: "single" | "couple" | "family"
   - monthlyIncome: number (‡∏ö‡∏≤‡∏ó)
4. ‡∏û‡∏≠‡∏Ñ‡∏£‡∏ö ‚Üí set ready: true + ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î

Mapping ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û:
- IT/software/dev/data/programmer ‚Üí "software"
- ‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£/engineer/mechanical/civil/electrical ‚Üí "engineering"
- ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/finance/accountant ‚Üí "accounting"
- ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•/nurse/‡∏´‡∏°‡∏≠/doctor/‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç/‡πÄ‡∏†‡∏™‡∏±‡∏ä ‚Üí "healthcare"
- ‡πÄ‡∏ä‡∏ü/chef/cook/‡∏Ñ‡∏£‡∏±‡∏ß/barista ‚Üí "chef"
- ‡∏≠‡∏∑‡πà‡∏ô‡πÜ/‡∏Ñ‡∏£‡∏π/teacher/marketing/design ‚Üí "other"

‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON:
{"message": "...", "gathered": {"goals": [], "occupation": "", "monthlyIncome": 0, "age": "", "family": "", "ready": false}}`

// ===== MAIN COMPONENT =====
export function ChatSimulator() {
  const [phase, setPhase] = useState<Phase>('welcome')

  // Quiz state
  const [quizStep, setQuizStep] = useState(0)
  const [goals, setGoals] = useState<string[]>([])
  const [occupation, setOccupation] = useState('')
  const [quickProfile, setQuickProfile] = useState<QuickProfile>({ age: '', monthlyIncome: '', savings: '', family: 'single' })

  // Country results
  const [matchResults, setMatchResults] = useState<MatchResult[]>([])
  const [selectedCountry, setSelectedCountry] = useState('')
  const [expandedCountry, setExpandedCountry] = useState('')

  // AU Profile
  const [auProfile, setAuProfile] = useState<AuProfile>({ english: '', experience: '', education: '', thaiSalary: '', city: 'melbourne' })

  // Simulation
  const [simStage, setSimStage] = useState(0)
  const [savingsInput, setSavingsInput] = useState('')
  const [isMotherLord, setIsMotherLord] = useState(false)
  const [initialAUD, setInitialAUD] = useState(0)
  const [choices, setChoices] = useState<Record<string, string>>({})

  // Occupation search
  const [occSearchMode, setOccSearchMode] = useState(false)
  const [occSearchQuery, setOccSearchQuery] = useState('')
  const [occDisplayLabel, setOccDisplayLabel] = useState('')

  // AI Chat state
  const [aiMode, setAiMode] = useState(false)
  const [apiKey] = useState(getStoredApiKey())
  const [aiMessages, setAiMessages] = useState<{ role: 'user' | 'bot'; text: string }[]>([])
  const [aiChatHistory, setAiChatHistory] = useState<ChatMessage[]>([])
  const [aiInput, setAiInput] = useState('')
  const [aiLoading, setAiLoading] = useState(false)
  const [aiGathered, setAiGathered] = useState<GatheredData>({ goals: [], occupation: '', monthlyIncome: 0, age: '', family: '', ready: false })
  const [aiAnalysis, setAiAnalysis] = useState('')
  const [aiError, setAiError] = useState('')
  const [chipSelected, setChipSelected] = useState<string[]>([])
  const [occChatSearch, setOccChatSearch] = useState('')
  const [showOccSearch, setShowOccSearch] = useState(false)
  const [goalsConfirmed, setGoalsConfirmed] = useState(false)

  const bottomRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    setTimeout(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), 200)
  }, [quizStep, phase, simStage, aiMessages.length])

  // Init: auto-start AI mode
  useEffect(() => {
    // Auto launch AI chat on first load
    if (phase === 'welcome' && apiKey) {
      startAiChat()
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [])

  // ===== AI HANDLERS =====
  const startAiChat = () => {
    setAiMode(true)
    setPhase('aiChat')
    const greeting = '‡πÄ‡∏´‡∏°‡∏µ‡∏¢‡∏ß! üê± ‡∏â‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠ Catto ‚Äî ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏´‡∏ô\n\n‡πÄ‡∏•‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏™‡∏¥ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡πÑ‡∏°‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏î‡∏≠‡∏¢‡∏≤‡∏Å‡∏¢‡πâ‡∏≤‡∏¢? üåç'
    setAiMessages([{ role: 'bot', text: greeting }])
    setAiChatHistory([{ role: 'system', content: AI_SYSTEM_PROMPT }, { role: 'assistant', content: JSON.stringify({ message: greeting, gathered: { goals: [], occupation: '', monthlyIncome: 0, age: '', family: '', ready: false } }) }])
  }

  const sendMessage = async (text: string) => {
    if (!text.trim() || aiLoading) return
    setAiInput('')
    setChipSelected([])
    setShowOccSearch(false)
    setOccChatSearch('')
    setAiError('')
    setAiMessages(prev => [...prev, { role: 'user', text: text.trim() }])
    setAiLoading(true)

    const newHistory: ChatMessage[] = [...aiChatHistory, { role: 'user', content: text.trim() }]
    setAiChatHistory(newHistory)

    try {
      const aiRes = await chatWithGroq(apiKey, newHistory)
      // Merge gathered: keep previously confirmed data, add new data from AI
      const merged: GatheredData = {
        goals: aiRes.gathered.goals.length > 0
          ? [...new Set([...aiGathered.goals, ...aiRes.gathered.goals])]
          : aiGathered.goals,
        occupation: aiRes.gathered.occupation || aiGathered.occupation,
        monthlyIncome: aiRes.gathered.monthlyIncome || aiGathered.monthlyIncome,
        age: aiRes.gathered.age || aiGathered.age,
        family: aiRes.gathered.family || aiGathered.family,
        ready: aiRes.gathered.ready,
      }
      setAiMessages(prev => [...prev, { role: 'bot', text: aiRes.message }])
      setAiChatHistory(prev => [...prev, { role: 'assistant', content: JSON.stringify({ message: aiRes.message, gathered: merged }) }])
      setAiGathered(merged)
    } catch (err) {
      setAiError(err instanceof Error ? err.message : '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞')
    }
    setAiLoading(false)
  }

  const sendAiMessage = () => sendMessage(aiInput)

  const runAiAnalysis = async (gathered: GatheredData, results: MatchResult[]) => {
    try {
      const userCtx = `‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${gathered.goals.join(', ')}, ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û: ${gathered.occupation}, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${gathered.monthlyIncome} ‡∏ö‡∏≤‡∏ó, ‡∏≠‡∏≤‡∏¢‡∏∏: ${gathered.age}, ‡πÑ‡∏õ: ${gathered.family}`
      const resultsCtx = results.map((r, i) => `${i + 1}. ${r.country.nameTH} (${r.matchPct}%) ‚Äî ${r.highlights.join(', ')}`).join('\\n')
      const analysis = await analyzeResults(apiKey, userCtx, resultsCtx)
      setAiAnalysis(analysis)
    } catch {
      // fail silently ‚Äî analysis is optional
    }
  }

  // ===== POST-CHAT NAVIGATION =====
  const applyGatheredData = (g: GatheredData) => {
    setGoals(g.goals)
    setOccupation(g.occupation)
    setQuickProfile({ age: g.age, monthlyIncome: String(g.monthlyIncome), savings: '', family: g.family })
  }

  const goToCountryAnalysis = async () => {
    applyGatheredData(aiGathered)
    setPhase('analyzing')
    const fallbackParams: MatchParams = {
      goals: aiGathered.goals, occupation: aiGathered.occupation,
      monthlyIncome: aiGathered.monthlyIncome, age: aiGathered.age, family: aiGathered.family,
    }
    try {
      const rankings = await rankCountriesWithAI(apiKey, fallbackParams, COUNTRIES)
      const results: MatchResult[] = rankings
        .map(r => {
          const country = COUNTRIES.find(c => c.id === r.countryId)
          if (!country) return null
          return { country, matchPct: r.matchPct, highlights: r.highlights, challenges: r.challenges.length > 0 ? r.challenges : country.cons, occupationNote: r.reason }
        })
        .filter((r): r is MatchResult => r !== null)
      // If AI returned bad country IDs ‚Üí fall through to hardcoded
      if (results.length === 0) throw new Error('no valid results from AI')
      setMatchResults(results)
      runAiAnalysis(aiGathered, results)
      setPhase('countryResults')
    } catch {
      // Fallback to hardcoded matching ‚Äî always produces results
      const results = matchCountries(fallbackParams)
      setMatchResults(results)
      runAiAnalysis(aiGathered, results)
      setPhase('countryResults')
    }
  }

  const goToAuSim = () => {
    applyGatheredData(aiGathered)
    setAuProfile(p => ({ ...p, thaiSalary: String(aiGathered.monthlyIncome) }))
    setPhase('auProfile')
  }

  // ===== CHIP HANDLERS =====
  const toggleChip = (id: string) => {
    setChipSelected(prev => prev.includes(id) ? prev.filter(x => x !== id) : prev.length < 3 ? [...prev, id] : prev)
  }

  const GOAL_LABELS: Record<string, string> = {
    'money-job': 'üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏µ ‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢',
    'balance': 'üèñÔ∏è Work-life balance',
    'family': 'üë®‚Äçüë©‚Äçüëß ‡∏•‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏µ ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£',
    'stable': 'üèõÔ∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á',
    'lifestyle': 'üå¥ ‡∏¢‡πâ‡∏≤‡∏¢‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì‡∏™‡∏ö‡∏≤‡∏¢',
  }

  const sendGoalChips = () => {
    if (chipSelected.length === 0) return
    const text = chipSelected.map(id => GOAL_LABELS[id] || id).join(', ')
    // Directly record goals + auto-confirm so chips advance to next phase
    setAiGathered(prev => ({
      ...prev,
      goals: [...new Set([...prev.goals, ...chipSelected])]
    }))
    setGoalsConfirmed(true)
    sendMessage(text)
  }

  // Pick occupation from search and send to AI
  const pickOccFromSearch = (title: string, occId: string) => {
    setShowOccSearch(false)
    setOccChatSearch('')
    // Directly record occupation ‚Äî don't rely solely on AI to echo it
    setAiGathered(prev => ({ ...prev, occupation: occId }))
    sendMessage(title)
  }

  // Quick occupation chip mapping ‚Üí proper AI-expected IDs
  const OCC_CHIP_MAP: { label: string; text: string; occId: string }[] = [
    { label: 'üíª Software Dev', text: 'Software Developer / ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå', occId: 'software' },
    { label: 'üìä Data / Analytics', text: 'Data Engineer / Analyst', occId: 'software' },
    { label: '‚òÅÔ∏è DevOps / Cloud', text: 'DevOps / Cloud Engineer', occId: 'software' },
    { label: 'ü§ñ AI / ML', text: 'AI / Machine Learning Engineer', occId: 'software' },
    { label: 'üîí Cybersecurity', text: 'Cybersecurity Analyst', occId: 'software' },
    { label: '‚öôÔ∏è ‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£', text: '‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£', occId: 'engineering' },
    { label: 'üè• ‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç', text: '‡πÅ‡∏û‡∏ó‡∏¢‡πå / ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', occId: 'healthcare' },
    { label: 'üìã ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', text: '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ / ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô', occId: 'accounting' },
    { label: 'üë®‚Äçüç≥ ‡πÄ‡∏ä‡∏ü', text: '‡πÄ‡∏ä‡∏ü / ‡∏Ñ‡∏£‡∏±‡∏ß', occId: 'chef' },
  ]
  const sendOccChip = (text: string, occId: string) => {
    setAiGathered(prev => ({ ...prev, occupation: occId }))
    sendMessage(text)
  }

  // Determine what chips to show ‚Äî match the LAST BOT MESSAGE topic, not just gathered state
  type ChipMode = 'none' | 'goals' | 'goals-confirm' | 'occ-search' | 'age' | 'family' | 'income'
  const getChipMode = (): ChipMode => {
    if (aiLoading || aiGathered.ready || aiMessages.length < 1) return 'none'
    const lastBotMsg = [...aiMessages].reverse().find(m => m.role === 'bot')
    if (!lastBotMsg) return 'none'
    const txt = lastBotMsg.text.toLowerCase()
    // Off-topic rejection ‚Üí no chips
    if (txt.includes('catto ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ')) return 'none'

    // Don't show chips until user has sent at least 1 message ‚Äî let them type freely first
    const userMsgCount = aiMessages.filter(m => m.role === 'user').length
    if (userMsgCount < 1) return 'none'

    // Detect what the AI is asking about from its message
    const asksIncome = /‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ|‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô|‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞|‡πÑ‡∏î‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£|salary|income/.test(txt)
    const asksAge = /‡∏≠‡∏≤‡∏¢‡∏∏|‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏µ|‡∏Å‡∏µ‡πà‡∏õ‡∏µ|age/.test(txt)
    const asksFamily = /‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß|‡πÑ‡∏õ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß|‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô|‡∏•‡∏π‡∏Å|single|family|couple/.test(txt)
    const asksOcc = /‡∏≠‡∏≤‡∏ä‡∏µ‡∏û|‡∏ó‡∏≥‡∏á‡∏≤‡∏ô|‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£|‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á|‡∏á‡∏≤‡∏ô.*‡∏≠‡∏∞‡πÑ‡∏£|occupation|job/.test(txt)

    // Priority: show chips matching what AI asks; fall back to gathered-state order
    if (asksIncome && aiGathered.monthlyIncome === 0) return 'income'
    if (asksAge && !aiGathered.age) return 'age'
    if (asksFamily && !aiGathered.family) return 'family'
    if (asksOcc && !aiGathered.occupation) return 'occ-search'

    // Fallback: follow gathered-state order for what's missing
    if (aiGathered.goals.length === 0) return 'goals'
    if (!goalsConfirmed) return 'goals-confirm'
    if (!aiGathered.occupation) return 'occ-search'
    if (!aiGathered.age) return 'age'
    if (!aiGathered.family) return 'family'
    if (aiGathered.monthlyIncome === 0) return 'income'
    return 'none'
  }

  // ===== DERIVED (AU SIMULATION) =====
  const auOccKey = occupation // new 6 IDs map directly to AU_SALARIES keys
  const city = AU_CITIES[auProfile.city] || AU_CITIES['melbourne']
  const salaryData = AU_SALARIES[auOccKey] || AU_SALARIES['other']

  const preDepartureCosts = useMemo(() => {
    const visa = quickProfile.family === 'family' ? 9825 : quickProfile.family === 'couple' ? 7365 : 4910
    return [
      { label: 'üìã Visa Application Fee', aud: visa },
      { label: 'üìù Skills Assessment', aud: 1000 },
      { label: 'üìñ IELTS/PTE ‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏©‡∏≤', aud: 400 },
      { label: 'üè• ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û Medical', aud: 400 },
      { label: 'üìÑ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£+‡πÅ‡∏õ‡∏•+‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á', aud: 500 },
    ]
  }, [quickProfile.family])
  const preDepartureTotal = preDepartureCosts.reduce((s, c) => s + c.aud, 0)

  const grossAnnual = choices['job'] === 'top' ? salaryData.senior : choices['job'] === 'min' ? AU_UNSKILLED_SALARY : salaryData.mid
  const monthlyRent = choices['housing'] === 'share' ? city.rentShare : choices['housing'] === '2bed' ? (quickProfile.family === 'family' ? city.rentFamily : city.rent2br) : city.rent1br
  const bond = monthlyRent
  const flightCost = choices['flight'] === 'business' ? (quickProfile.family === 'single' ? 4500 : quickProfile.family === 'couple' ? 9000 : 13500) : choices['flight'] === 'company' ? 0 : (quickProfile.family === 'single' ? 1100 : quickProfile.family === 'couple' ? 2200 : 3500)
  const tempCost = choices['temp'] === 'airbnb' ? 2100 : choices['temp'] === 'hostel' ? 700 : 0
  const furnishCost = choices['furnish'] === 'nice' ? 4000 : choices['furnish'] === 'ikea' ? 2000 : choices['furnish'] === 'second' ? 800 : 0

  const oneTimeCosts = useMemo(() => {
    let total = 0
    if (simStage > 1) total += preDepartureTotal
    if (simStage > 3) total += flightCost
    if (simStage > 4) total += tempCost
    if (simStage > 5) total += bond
    if (simStage > 6) total += furnishCost
    return total
  }, [simStage, preDepartureTotal, flightCost, tempCost, bond, furnishCost])

  const balanceAUD = isMotherLord ? Infinity : initialAUD - oneTimeCosts

  const auTax = calculateAusTax(grossAnnual)
  const monthlyNet = auTax.netMonthly
  const monthlyFood = FOOD_COSTS[choices['food']]?.cost || 550
  const monthlyTransport = TRANSPORT_COSTS[choices['commute']]?.cost || 200
  const monthlyInsurance = choices['insurance'] === 'private' ? 150 : 0
  const monthlyUtils = city.utilities + city.internet
  const monthlyPhone = 50
  const monthlyMisc = 250
  const totalMonthlyExp = monthlyRent + monthlyUtils + monthlyFood + monthlyTransport + monthlyInsurance + monthlyPhone + monthlyMisc
  const monthlySavings = monthlyNet - totalMonthlyExp
  const monthlySavingsTHB = Math.round(monthlySavings * AUD_TO_THB)

  const thaiSalary = parseInt(auProfile.thaiSalary) || parseInt(quickProfile.monthlyIncome) || 40000
  const thaiTax = calculateThaiTax(thaiSalary * 12)
  const thaiNetMonthly = thaiTax.netMonthly
  const thaiMonthlySavings = thaiNetMonthly - TH_TOTAL_LIVING

  const visa = calculateSimpleVisaScore(quickProfile.age, auProfile.english, auProfile.experience, auProfile.education, choices['job'] === 'min' ? 'unskilled' : 'skilled')
  const finalOneTime = preDepartureTotal + flightCost + tempCost + bond + furnishCost

  // ===== HANDLERS =====
  const toggleGoal = (id: string) => {
    setGoals(prev => prev.includes(id) ? prev.filter(x => x !== id) : prev.length < 3 ? [...prev, id] : prev)
  }

  const confirmGoals = () => {
    if (goals.length >= 1) setQuizStep(1)
  }

  const pickOccupation = (id: string, displayLabel?: string) => {
    setOccupation(id)
    if (displayLabel) setOccDisplayLabel(displayLabel)
    setOccSearchMode(false)
    setOccSearchQuery('')
    setQuizStep(2)
  }

  const upQ = (field: keyof QuickProfile, val: string) => setQuickProfile(p => ({ ...p, [field]: val }))

  const confirmProfile = () => {
    if (quickProfile.age && quickProfile.monthlyIncome) startAnalyzing()
  }

  const startAnalyzing = () => {
    setPhase('analyzing')
    setTimeout(() => {
      const params: MatchParams = {
        goals,
        occupation,
        monthlyIncome: parseInt(quickProfile.monthlyIncome) || 30000,
        age: quickProfile.age,
        family: quickProfile.family,
      }
      const results = matchCountries(params)
      setMatchResults(results)
      setPhase('countryResults')
    }, 2500)
  }

  const selectCountryForDeepDive = (countryId: string) => {
    setSelectedCountry(countryId)
    if (countryId === 'australia') {
      setAuProfile(p => ({ ...p, thaiSalary: quickProfile.monthlyIncome }))
      setPhase('auProfile')
    }
  }

  const upAU = (field: keyof AuProfile, val: string) => setAuProfile(p => ({ ...p, [field]: val }))
  const allAuFilled = auProfile.english && auProfile.experience && auProfile.education && auProfile.thaiSalary

  const startSim = () => {
    if (allAuFilled) { setPhase('sim'); setSimStage(0) }
  }

  const commitSavings = (motherLord: boolean) => {
    if (motherLord) { setIsMotherLord(true); setInitialAUD(9999999) }
    else {
      const thb = parseInt(savingsInput) || 0
      setInitialAUD(Math.round(thb / AUD_TO_THB))
    }
    setSimStage(1)
  }

  const advanceStage = () => setSimStage(s => s + 1)
  const pick = (stageId: string, optionId: string) => { setChoices(prev => ({ ...prev, [stageId]: optionId })); setSimStage(s => s + 1) }

  const restart = () => {
    setPhase('welcome'); setQuizStep(0); setGoals([]); setOccupation('')
    setQuickProfile({ age: '', monthlyIncome: '', savings: '', family: 'single' })
    setMatchResults([]); setSelectedCountry(''); setExpandedCountry('')
    setAuProfile({ english: '', experience: '', education: '', thaiSalary: '', city: 'melbourne' })
    setSimStage(0); setSavingsInput(''); setIsMotherLord(false); setInitialAUD(0); setChoices({})
    setAiMessages([]); setAiChatHistory([]); setAiInput(''); setAiGathered({ goals: [], occupation: '', monthlyIncome: 0, age: '', family: '', ready: false })
    setAiAnalysis(''); setAiError(''); setOccDisplayLabel(''); setChipSelected([]); setShowOccSearch(false); setOccChatSearch(''); setAiMode(false); setGoalsConfirmed(false)
    // Re-start AI chat after reset
    setTimeout(() => {
      setAiMode(true)
      setPhase('aiChat')
      const greeting = '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á! üëã ‡πÄ‡∏•‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡πÑ‡∏°‡∏ñ‡∏∂‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®? üåç'
      setAiMessages([{ role: 'bot', text: greeting }])
      setAiChatHistory([{ role: 'system', content: AI_SYSTEM_PROMPT }, { role: 'assistant', content: JSON.stringify({ message: greeting, gathered: { goals: [], occupation: '', monthlyIncome: 0, age: '', family: '', ready: false } }) }])
    }, 100)
  }

  // ================================================================
  // ===== RENDER: WELCOME =====
  // ================================================================
  if (phase === 'welcome') {
    return (
      <div className="sim-container">
        <div className="sim-scroll flex flex-col items-center justify-center min-h-[450px]">
          <div className="text-center animate-fade-in">
            <div className="text-5xl mb-4">üê±</div>
            <div className="text-2xl font-bold text-gray-800 mb-2">‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏´‡∏ô?</div>
            <div className="text-sm text-gray-500 mb-8">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å 14 ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® ‚Äî ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ß‡∏µ‡∏ã‡πà‡∏≤ ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡∏ä‡∏µ‡∏û ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á</div>

            <button onClick={startAiChat} className="btn-primary w-full justify-center rounded-xl py-4 text-base mb-3">
              üê± ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
            </button>

            <button onClick={() => setPhase('quiz')} className="w-full py-3 rounded-xl border-2 border-gray-200 text-gray-500 hover:bg-gray-50 text-sm font-medium">
              üìã ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ AI)
            </button>
          </div>
        </div>
      </div>
    )
  }

  // ================================================================
  // ===== RENDER: AI CHAT =====
  // ================================================================
  if (phase === 'aiChat') {
    const chipMode = getChipMode()
    const occResults = occChatSearch.length >= 1 ? searchOccupations(occChatSearch) : []
    return (
      <div className="sim-container">
        <div className="sim-scroll">
          {/* Chat messages */}
          {aiMessages.map((msg, i) => (
            msg.role === 'bot'
              ? <BotMsg key={i}>{msg.text}</BotMsg>
              : <UserMsg key={i}>{msg.text}</UserMsg>
          ))}

          {/* Loading indicator */}
          {aiLoading && (
            <div className="chat-bubble bot animate-fade-in">
              <span className="bot-avatar">üê±</span>
              <div className="bubble-content ai-typing">
                <span className="dot" /><span className="dot" /><span className="dot" />
              </div>
            </div>
          )}

          {/* ===== GOALS: multi-select chips (fallback if AI didn't detect) ===== */}
          {chipMode === 'goals' && (
            <div className="quick-replies animate-fade-in">
              <div className="chip-hint">üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì 1-3 ‡∏Ç‡πâ‡∏≠ (‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)</div>
              <div className="chip-grid">
                {Object.entries(GOAL_LABELS).map(([id, label]) => (
                  <button
                    key={id}
                    onClick={() => toggleChip(id)}
                    className={`quick-chip ${chipSelected.includes(id) ? 'selected' : ''}`}
                  >
                    {label}
                  </button>
                ))}
              </div>
              {chipSelected.length > 0 && (
                <button onClick={sendGoalChips} className="chip-confirm animate-fade-in">
                  ‚úÖ ‡∏™‡πà‡∏á {chipSelected.length} ‡∏Ç‡πâ‡∏≠
                </button>
              )}
            </div>
          )}

          {/* ===== GOALS CONFIRM: after AI detected goals, ask "‡∏°‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡πÑ‡∏´‡∏°?" ===== */}
          {chipMode === 'goals-confirm' && (
            <div className="quick-replies animate-fade-in">
              <div className="chip-hint">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î &ldquo;‡πÑ‡∏õ‡∏ï‡πà‡∏≠&rdquo; üëá</div>
              <div className="chip-grid">
                {Object.entries(GOAL_LABELS)
                  .filter(([id]) => !aiGathered.goals.includes(id))
                  .map(([id, label]) => (
                    <button
                      key={id}
                      onClick={() => toggleChip(id)}
                      className={`quick-chip ${chipSelected.includes(id) ? 'selected' : ''}`}
                    >
                      {label}
                    </button>
                  ))}
              </div>
              {chipSelected.length > 0 && (
                <button onClick={() => {
                  const text = chipSelected.map(id => GOAL_LABELS[id] || id).join(', ')
                  // Directly add selected goals
                  setAiGathered(prev => ({ ...prev, goals: [...new Set([...prev.goals, ...chipSelected])] }))
                  sendMessage(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏≠‡∏µ‡∏Å: ${text}`)
                  setGoalsConfirmed(true)
                }} className="chip-confirm animate-fade-in">
                  ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° {chipSelected.length} ‡∏Ç‡πâ‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ï‡πà‡∏≠
                </button>
              )}
              <button onClick={() => {
                setGoalsConfirmed(true)
                sendMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢')
              }} className="chip-confirm" style={{ background: 'linear-gradient(135deg, #e5e7eb, #d1d5db)', color: '#374151', marginTop: '4px' }}>
                üëâ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢
              </button>
            </div>
          )}

          {/* ===== OCCUPATION: searchable dropdown ===== */}
          {chipMode === 'occ-search' && (
            <div className="quick-replies animate-fade-in">
              <div className="chip-hint">üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
              <div className="occ-chat-search">
                <input
                  type="text"
                  value={occChatSearch}
                  onChange={e => { setOccChatSearch(e.target.value); setShowOccSearch(true) }}
                  onFocus={() => setShowOccSearch(true)}
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô nurse, developer, ‡∏Ñ‡∏£‡∏π, ‡πÄ‡∏ä‡∏ü..."
                  className="occ-chat-input"
                />
                {showOccSearch && occChatSearch.length >= 1 && (
                  <div className="occ-chat-results">
                    {occResults.map(r => (
                      <button
                        key={r.key}
                        onClick={() => pickOccFromSearch(r.title, r.occId)}
                        className="occ-chat-item"
                      >
                        <span className="occ-chat-title">{r.title}</span>
                        <span className="occ-chat-cat">{r.category}</span>
                      </button>
                    ))}
                    {occResults.length === 0 && (
                      <div className="occ-chat-empty">
                        ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‚Äî <button onClick={() => sendMessage(occChatSearch)} className="occ-chat-fallback">‡πÉ‡∏ä‡πâ &ldquo;{occChatSearch}&rdquo; ‡πÄ‡∏•‡∏¢</button>
                      </div>
                    )}
                  </div>
                )}
              </div>
              {/* Quick picks below search */}
              <div className="chip-grid" style={{ marginTop: '8px' }}>
                {OCC_CHIP_MAP.map(c => (
                  <button key={c.occId} onClick={() => sendOccChip(c.text, c.occId)} className="quick-chip small">
                    {c.label}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* ===== AGE: single-tap chips ===== */}
          {chipMode === 'age' && (
            <div className="quick-replies animate-fade-in">
              <div className="chip-hint">‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏¢ ‚úçÔ∏è</div>
              <div className="chip-grid">
                {['18-24 ‡∏õ‡∏µ', '25-32 ‡∏õ‡∏µ', '33-39 ‡∏õ‡∏µ', '40-44 ‡∏õ‡∏µ', '45+ ‡∏õ‡∏µ'].map(label => (
                  <button key={label} onClick={() => sendMessage(label)} className="quick-chip">{label}</button>
                ))}
              </div>
            </div>
          )}

          {/* ===== FAMILY: single-tap chips ===== */}
          {chipMode === 'family' && (
            <div className="quick-replies animate-fade-in">
              <div className="chip-hint">‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏¢ ‚úçÔ∏è</div>
              <div className="chip-grid">
                {[
                  { label: 'üßë ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß' },
                  { label: 'üë´ ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å' },
                  { label: 'üë®‚Äçüë©‚Äçüëß ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß' },
                ].map(c => (
                  <button key={c.label} onClick={() => sendMessage(c.label)} className="quick-chip">{c.label}</button>
                ))}
              </div>
            </div>
          )}

          {/* ===== INCOME: single-tap chips ===== */}
          {chipMode === 'income' && (
            <div className="quick-replies animate-fade-in">
              <div className="chip-hint">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‚úçÔ∏è</div>
              <div className="chip-grid">
                {['15,000 ‡∏ö‡∏≤‡∏ó', '25,000 ‡∏ö‡∏≤‡∏ó', '35,000 ‡∏ö‡∏≤‡∏ó', '50,000 ‡∏ö‡∏≤‡∏ó', '80,000 ‡∏ö‡∏≤‡∏ó', '100,000 ‡∏ö‡∏≤‡∏ó', '150,000 ‡∏ö‡∏≤‡∏ó', '200,000+ ‡∏ö‡∏≤‡∏ó'].map(label => (
                  <button key={label} onClick={() => sendMessage(label)} className="quick-chip">{label}</button>
                ))}
              </div>
            </div>
          )}

          {/* Gathered info badges */}
          {(aiGathered.goals.length > 0 || aiGathered.occupation) && !aiGathered.ready && (
            <div className="ai-gathered animate-fade-in">
              {aiGathered.goals.length > 0 && <span className="ai-badge">üéØ {aiGathered.goals.map(g => GOAL_LABELS[g] || g).join(', ')}</span>}
              {aiGathered.occupation && <span className="ai-badge">üíº {aiGathered.occupation}</span>}
              {aiGathered.monthlyIncome > 0 && <span className="ai-badge">üí∞ {aiGathered.monthlyIncome.toLocaleString()}‡∏ø</span>}
              {aiGathered.age && <span className="ai-badge">üìÖ {aiGathered.age}</span>}
              {aiGathered.family && <span className="ai-badge">üë• {aiGathered.family}</span>}
            </div>
          )}

          {/* Error */}
          {aiError && (
            <div className="ai-error animate-fade-in">
              ‚ö†Ô∏è {aiError}
              <button onClick={() => setAiError('')} className="text-xs text-blue-600 underline ml-2">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
            </div>
          )}

          {/* Ready ‚Äî show choice buttons */}
          {aiGathered.ready && (
            <div className="ai-done-card animate-fade-in">
              <div className="text-center mb-4">
                <div className="text-3xl mb-1">‚ú®</div>
                <div className="text-lg font-bold text-gray-800">Catto ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß! üê±</div>
                <div className="text-xs text-gray-500 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏î‡∏π‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≠</div>
              </div>
              <button onClick={goToCountryAnalysis} className="btn-primary w-full justify-center rounded-xl py-3 text-sm mb-2">
                üìä ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö 14 ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
              </button>
              <button onClick={goToAuSim} className="w-full py-3 rounded-xl border-2 border-blue-200 text-blue-600 hover:bg-blue-50 text-sm font-medium">
                üá¶üá∫ ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏™‡πÄ‡∏•‡∏¢!
              </button>
            </div>
          )}

          <div ref={bottomRef} />
        </div>

        {/* Input bar */}
        {!aiGathered.ready && (
          <div className="ai-input-bar">
            <input
              type="text"
              value={aiInput}
              onChange={e => setAiInput(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && sendAiMessage()}
              placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..."
              className="ai-text-input"
              disabled={aiLoading}
              autoFocus
            />
            <button onClick={sendAiMessage} disabled={aiLoading || !aiInput.trim()} className="ai-send-btn">
              ‚û§
            </button>
          </div>
        )}
      </div>
    )
  }

  // ================================================================
  // ===== RENDER: QUIZ =====
  // ================================================================
  if (phase === 'quiz') {
    return (
      <div className="sim-container">
        <div className="sim-scroll">
          {/* Quiz Progress */}
          <div className="quiz-progress">
            {['‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏≠‡∏∞‡πÑ‡∏£', '‡∏≠‡∏≤‡∏ä‡∏µ‡∏û', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'].map((label, i) => (
              <div key={i} className={`quiz-step-dot ${i < quizStep ? 'done' : i === quizStep ? 'current' : ''}`}>
                <span className="quiz-step-num">{i + 1}</span>
                <span className="quiz-step-label">{label}</span>
              </div>
            ))}
          </div>

          {/* ===== STEP 0: GOALS ===== */}
          <BotMsg>
            ‡∏ß‡πà‡∏≤‡πÑ‡∏á! üëã ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÄ‡∏´‡∏£‡∏≠?<br />
            <strong>‡∏≠‡∏∞‡πÑ‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?</strong> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 1-3 ‡∏Ç‡πâ‡∏≠
          </BotMsg>

          {quizStep === 0 && (
            <div className="animate-fade-in">
              <div className="options-grid">
                {GOALS.map(g => (
                  <button key={g.id} onClick={() => toggleGoal(g.id)}
                    className={`chat-option-btn ${goals.includes(g.id) ? 'selected' : ''}`}>
                    {g.label}
                  </button>
                ))}
              </div>
              {goals.length >= 1 && (
                <button onClick={confirmGoals} className="btn-primary w-full mt-3 justify-center rounded-xl py-3 text-sm">
                  ‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß! ({goals.length} ‡∏Ç‡πâ‡∏≠)
                </button>
              )}
            </div>
          )}

          {/* User chose goals */}
          {quizStep >= 1 && (
            <>
              <UserMsg>{goals.map(g => GOALS.find(x => x.id === g)?.emoji).join(' ')}</UserMsg>
              <BotMsg>
                {GOALS.find(x => x.id === goals[0])?.response || '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏•‡∏¢!'}<br /><br />
                ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ <strong>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡∏≠‡∏∞‡πÑ‡∏£?</strong> üíº ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏Ç‡∏≤‡∏î‡πÅ‡∏Ñ‡∏•‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô
              </BotMsg>
            </>
          )}

          {/* ===== STEP 1: OCCUPATION ===== */}
          {quizStep === 1 && (
            <div className="animate-fade-in">
              {!occSearchMode ? (
                <div className="options-grid">
                  {OCCUPATIONS.filter(o => o.id !== 'other').map(o => (
                    <button key={o.id} onClick={() => pickOccupation(o.id)} className="chat-option-btn">
                      {o.label}
                    </button>
                  ))}
                  <button onClick={() => setOccSearchMode(true)} className="chat-option-btn occ-search-trigger">
                    üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏≠‡∏∑‡πà‡∏ô
                  </button>
                </div>
              ) : (
                <div className="occ-search-box">
                  <input
                    type="text"
                    value={occSearchQuery}
                    onChange={e => setOccSearchQuery(e.target.value)}
                    placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‡πÄ‡∏ä‡πà‡∏ô nurse, engineer, chef..."
                    className="occ-search-input"
                    autoFocus
                  />
                  {occSearchQuery.length >= 1 && (
                    <div className="occ-search-results">
                      {searchOccupations(occSearchQuery).map(r => (
                        <button
                          key={r.key}
                          onClick={() => pickOccupation(r.occId, r.title)}
                          className="occ-search-item"
                        >
                          <span className="occ-search-title">{r.title}</span>
                          <span className="occ-search-cat">{r.category}</span>
                        </button>
                      ))}
                      {searchOccupations(occSearchQuery).length === 0 && (
                        <div className="occ-search-empty">
                          ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‚Äî <button onClick={() => pickOccupation('other', occSearchQuery)} className="occ-search-fallback">‡πÉ‡∏ä‡πâ &ldquo;{occSearchQuery}&rdquo; ‡πÄ‡∏•‡∏¢</button>
                        </div>
                      )}
                    </div>
                  )}
                  <button onClick={() => { setOccSearchMode(false); setOccSearchQuery('') }} className="text-xs text-gray-500 mt-2 hover:text-gray-700">
                    ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å
                  </button>
                </div>
              )}
            </div>
          )}

          {/* User chose occupation */}
          {quizStep >= 2 && (
            <>
              <UserMsg>{occDisplayLabel || OCCUPATIONS.find(o => o.id === occupation)?.label || occupation}</UserMsg>
              <BotMsg>
                ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! üéØ ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡πâ<br />
                <span className="text-xs text-gray-500">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô üîí</span>
              </BotMsg>
            </>
          )}

          {/* ===== STEP 2: QUICK PROFILE (and auto-analyze) ===== */}
          {quizStep === 2 && (
            <div className="stage-card animate-fade-in">
              <div className="stage-body space-y-3">
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="form-label">üìÖ ‡∏≠‡∏≤‡∏¢‡∏∏</label>
                    <select className="form-select" value={quickProfile.age} onChange={e => upQ('age', e.target.value)}>
                      <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option>
                      <option value="18-24">18-24 ‡∏õ‡∏µ</option>
                      <option value="25-32">25-32 ‡∏õ‡∏µ ‚≠ê</option>
                      <option value="33-39">33-39 ‡∏õ‡∏µ</option>
                      <option value="40-44">40-44 ‡∏õ‡∏µ</option>
                      <option value="45+">45+ ‡∏õ‡∏µ</option>
                    </select>
                  </div>
                  <div>
                    <label className="form-label">üë• ‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£</label>
                    <select className="form-select" value={quickProfile.family} onChange={e => upQ('family', e.target.value)}>
                      <option value="single">üßë ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</option>
                      <option value="couple">üë´ ‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏£‡∏±‡∏Å</option>
                      <option value="family">üë®‚Äçüë©‚Äçüëß ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label className="form-label">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                  <input type="number" className="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 45000"
                    value={quickProfile.monthlyIncome} onChange={e => upQ('monthlyIncome', e.target.value)} />
                </div>
                <div>
                  <label className="form-label">üè¶ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                  <select className="form-select" value={quickProfile.savings} onChange={e => upQ('savings', e.target.value)}>
                    <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option>
                    <option value="under100k">‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 100,000 ‡∏ö‡∏≤‡∏ó</option>
                    <option value="100k-300k">100,000 - 300,000 ‡∏ö‡∏≤‡∏ó</option>
                    <option value="300k-500k">300,000 - 500,000 ‡∏ö‡∏≤‡∏ó</option>
                    <option value="500k-1m">500,000 - 1,000,000 ‡∏ö‡∏≤‡∏ó</option>
                    <option value="over1m">‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1,000,000 ‡∏ö‡∏≤‡∏ó</option>
                  </select>
                </div>
                {quickProfile.age && quickProfile.monthlyIncome && (
                  <button onClick={confirmProfile} className="btn-primary w-full mt-2 justify-center rounded-xl py-3 text-sm animate-fade-in">
                    üîç ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏•‡∏¢!
                  </button>
                )}
              </div>
            </div>
          )}

          <div ref={bottomRef} />
        </div>
      </div>
    )
  }

  // ================================================================
  // ===== RENDER: ANALYZING =====
  // ================================================================
  if (phase === 'analyzing') {
    return (
      <div className="sim-container">
        <div className="sim-scroll flex flex-col items-center justify-center min-h-[400px]">
          <div className="analyzing-screen animate-fade-in text-center">
            <div className="text-5xl mb-4 analyzing-globe">üåç</div>
            <div className="text-xl font-bold text-gray-800 mb-2">{aiMode ? 'üê± Catto ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì...' : `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ${COUNTRIES.length} ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®...`}</div>
            <div className="text-sm text-gray-500 mb-4">
              {aiMode
                ? `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ${COUNTRIES.length} ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® ‚Äî ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ß‡∏µ‡∏ã‡πà‡∏≤ ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡∏ä‡∏µ‡∏û‡∏à‡∏£‡∏¥‡∏á`
                : `‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ${goals.length} goals √ó ‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ${occDisplayLabel || OCCUPATIONS.find(o => o.id === occupation)?.labelTH} √ó ${COUNTRIES.length} ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®`
              }
            </div>
            <div className="analyzing-bar">
              <div className="analyzing-bar-fill" />
            </div>
            <div className="text-xs text-gray-400 mt-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: OECD, Numbeo, Global Peace Index 2025</div>
          </div>
        </div>
      </div>
    )
  }

  // ================================================================
  // ===== RENDER: COUNTRY RESULTS =====
  // ================================================================
  if (phase === 'countryResults') {
    return (
      <div className="sim-container">
        <div className="sim-scroll">
          <div className="text-center mb-4 animate-fade-in">
            <div className="text-3xl font-bold text-gray-800 mb-1">üåç ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì!</div>
            <div className="text-sm text-gray-500">{aiMode ? 'üê± Catto ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å' : '‡∏à‡∏≤‡∏Å'} {COUNTRIES.length} ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® ‚Äî ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ Top 5 ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì</div>
          </div>

          <div className="space-y-3">
            {matchResults.map((result, idx) => {
              const isAU = result.country.id === 'australia'
              const isExpanded = expandedCountry === result.country.id
              return (
                <div key={result.country.id}
                  className={`country-card animate-fade-in ${isAU ? 'country-card-au' : ''}`}
                  style={{ animationDelay: `${idx * 0.1}s` }}>

                  {/* Header */}
                  <div className="country-card-header" onClick={() => setExpandedCountry(isExpanded ? '' : result.country.id)}>
                    <div className="flex items-center gap-3">
                      <div className="text-3xl">{result.country.flag}</div>
                      <div>
                        <div className="font-bold text-gray-800">{result.country.nameTH}</div>
                        <div className="text-xs text-gray-500">{result.country.name}</div>
                      </div>
                    </div>
                    <div className="text-right">
                      <div className={`text-2xl font-bold ${result.matchPct >= 75 ? 'text-green-600' : result.matchPct >= 55 ? 'text-blue-600' : 'text-orange-500'}`}>
                        {result.matchPct}%
                      </div>
                      <div className="text-xs text-gray-400">match</div>
                    </div>
                  </div>

                  {/* Match bar */}
                  <div className="match-bar-bg">
                    <div className="match-bar-fill" style={{
                      width: `${result.matchPct}%`,
                      background: result.matchPct >= 75 ? 'linear-gradient(90deg, #22c55e, #16a34a)' : result.matchPct >= 55 ? 'linear-gradient(90deg, #3b82f6, #2563eb)' : 'linear-gradient(90deg, #f97316, #ea580c)',
                    }} />
                  </div>

                  {/* Highlights */}
                  <div className="country-highlights">
                    {result.highlights.map((h, i) => (
                      <div key={i} className="text-sm">{h}</div>
                    ))}
                  </div>

                  {/* Salary summary (always visible) */}
                  {(() => {
                    const userOcc = aiMode ? aiGathered.occupation : occupation
                    const salary = getOccSalary(result.country.id, userOcc)
                    const cur = result.country.currency || 'USD'
                    const sym = CURRENCY_SYMBOLS[cur] || cur
                    const thbRate = CURRENCY_TO_THB[cur] || 1
                    if (salary) {
                      const thbMonthly = Math.round(salary.mid * thbRate / 12)
                      return <div className="text-xs px-4 pb-1 text-gray-500">üí∞ {sym}{salary.mid.toLocaleString()}/‡∏õ‡∏µ (~{thbMonthly.toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</div>
                    }
                    const localSalary = Math.round(result.country.avgSalaryUSD * 34.5 / thbRate)
                    const thbMonthly = Math.round(localSalary * thbRate / 12)
                    return <div className="text-xs px-4 pb-1 text-gray-500">üí∞ ~{sym}{localSalary.toLocaleString()}/‡∏õ‡∏µ (~{thbMonthly.toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</div>
                  })()}

                  {/* Occupation note */}
                  {result.occupationNote && (
                    <div className="text-xs px-4 pb-2 text-blue-700 font-medium">{result.occupationNote}</div>
                  )}

                  {/* Expanded details */}
                  {isExpanded && (
                    <div className="country-expanded animate-fade-in">
                      {/* Score breakdown */}
                      <div className="text-xs font-semibold text-gray-600 mb-1">üìä ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏î‡πâ‡∏≤‡∏ô (1-10):</div>
                      <div className="grid grid-cols-2 gap-x-3 gap-y-0.5 mb-2 text-[11px]">
                        {([
                          ['jobMarket', 'üíº ‡∏ï‡∏•‡∏≤‡∏î‡∏á‡∏≤‡∏ô'],
                          ['workLifeBalance', '‚öñÔ∏è Work-life'],
                          ['safety', 'üõ°Ô∏è ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢'],
                          ['healthcare', 'üè• ‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç'],
                          ['education', 'üéì ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤'],
                          ['politicalStability', 'üèõÔ∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á'],
                          ['costOfLiving', 'üí∞ ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡∏ä‡∏µ‡∏û'],
                          ['taxFriendliness', 'üßæ ‡∏†‡∏≤‡∏©‡∏µ'],
                          ['climate', '‚òÄÔ∏è ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®'],
                          ['immigrationEase', '‚úàÔ∏è ‡∏¢‡πâ‡∏≤‡∏¢‡∏á‡πà‡∏≤‡∏¢'],
                        ] as const).map(([key, label]) => {
                          const val = result.country.scores[key as keyof typeof result.country.scores]
                          const barColor = val >= 8 ? 'bg-green-400' : val >= 6 ? 'bg-blue-400' : val >= 4 ? 'bg-yellow-400' : 'bg-red-400'
                          return (
                            <div key={key} className="flex items-center gap-1">
                              <span className="w-20 text-gray-500 truncate">{label}</span>
                              <div className="flex-1 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                <div className={`h-full ${barColor} rounded-full`} style={{ width: `${val * 10}%` }} />
                              </div>
                              <span className="w-4 text-right text-gray-400">{val}</span>
                            </div>
                          )
                        })}
                      </div>
                      <div className="text-[10px] text-gray-400 mb-2">üìö ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å: OECD Better Life Index, Numbeo, Global Peace Index, UNDP HDR, Fragile States Index 2024-25</div>
                      <div className="text-xs font-semibold text-gray-600 mb-1">‡∏ß‡∏µ‡∏ã‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:</div>
                      <div className="text-xs text-gray-500 mb-2">{result.country.visaPaths.join(' ‚Ä¢ ')}</div>
                      <div className="text-xs font-semibold text-gray-600 mb-1">‡∏Ç‡πâ‡∏≠‡∏î‡∏µ:</div>
                      {result.country.pros.map((p, i) => <div key={i} className="text-xs text-green-700">‚úÖ {p}</div>)}
                      <div className="text-xs font-semibold text-gray-600 mt-2 mb-1">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏π‡πâ:</div>
                      {result.country.cons.map((c, i) => <div key={i} className="text-xs text-orange-600">‚ö†Ô∏è {c}</div>)}
                      {(() => {
                        const userOcc = aiMode ? aiGathered.occupation : occupation
                        const salary = getOccSalary(result.country.id, userOcc)
                        const occLabel = OCCUPATIONS.find(o => o.id === userOcc)?.labelTH || userOcc
                        const cur = result.country.currency || 'USD'
                        const sym = CURRENCY_SYMBOLS[cur] || cur
                        const thbRate = CURRENCY_TO_THB[cur] || 1
                        if (salary) {
                          const midMonthlyTHB = Math.round(salary.mid * thbRate / 12)
                          return (
                            <div className="text-xs mt-2 space-y-1">
                              <div className="text-blue-600 font-medium">üíº ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô {occLabel} ({sym}/‡∏õ‡∏µ):</div>
                              <div className="text-gray-600">üü¢ Entry: {sym}{salary.entry.toLocaleString()} ‚Üí Mid: {sym}{salary.mid.toLocaleString()} ‚Üí Senior: {sym}{salary.senior.toLocaleString()}</div>
                              <div className="text-gray-500">‚âà Mid ~{midMonthlyTHB.toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                              <div className="text-gray-400">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡∏ä‡∏µ‡∏û {result.country.costIndex}% ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢ | ‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢: {result.country.thaiCommunity === 'large' ? '‡πÄ‡∏¢‡∏≠‡∏∞' : result.country.thaiCommunity === 'medium' ? '‡∏û‡∏≠‡∏°‡∏µ' : '‡∏ô‡πâ‡∏≠‡∏¢'}</div>
                            </div>
                          )
                        }
                        const localSalary = Math.round(result.country.avgSalaryUSD * 34.5 / thbRate)
                        const thbMonthly = Math.round(localSalary * thbRate / 12)
                        return <div className="text-xs text-gray-400 mt-2">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ ~{sym}{localSalary.toLocaleString()}/‡∏õ‡∏µ (~{thbMonthly.toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô) | ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡∏ä‡∏µ‡∏û {result.country.costIndex}% ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢ | ‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢: {result.country.thaiCommunity === 'large' ? '‡πÄ‡∏¢‡∏≠‡∏∞' : result.country.thaiCommunity === 'medium' ? '‡∏û‡∏≠‡∏°‡∏µ' : '‡∏ô‡πâ‡∏≠‡∏¢'}</div>
                      })()}
                    </div>
                  )}

                  {/* CTA for AU */}
                  {isAU && (
                    <div className="px-4 pb-4">
                      <button onClick={() => selectCountryForDeepDive('australia')} className="btn-primary w-full justify-center rounded-xl py-3 text-base">
                        üéÆ ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏™! (‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)
                      </button>
                    </div>
                  )}

                  {/* Expand/collapse hint */}
                  {!isAU && (
                    <div className="text-center pb-3">
                      <button onClick={() => setExpandedCountry(isExpanded ? '' : result.country.id)} className="text-xs text-blue-500 hover:text-blue-700">
                        {isExpanded ? '‚ñ≤ ‡∏¢‡πà‡∏≠' : '‚ñº ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}
                      </button>
                    </div>
                  )}
                </div>
              )
            })}
          </div>

          {/* Note about AU if not in top 5 */}
          {!matchResults.some(r => r.country.id === 'australia') && (
            <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-xl text-center animate-fade-in">
              <div className="text-sm text-blue-800">
                ‡∏≠‡∏≠‡∏™‡πÄ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Top 5 ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏™<br />
                <button onClick={() => selectCountryForDeepDive('australia')} className="text-blue-600 font-semibold underline mt-1 hover:text-blue-800">
                  ‡∏•‡∏≠‡∏á‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏™‡∏≠‡∏¢‡∏π‡πà‡∏î‡∏µ‡πÑ‡∏´‡∏°?
                </button>
              </div>
            </div>
          )}

          {/* AI Analysis */}
          {aiMode && aiAnalysis && (
            <div className="ai-analysis-card animate-fade-in mt-4">
              <div className="text-sm font-bold text-gray-800 mb-2">üê± Catto ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì</div>
              <div className="text-sm text-gray-700 whitespace-pre-wrap">{aiAnalysis}</div>
            </div>
          )}

          {/* Data Sources & Disclaimer */}
          <div className="mt-4 bg-blue-50 border border-blue-200 rounded-xl p-3">
            <div className="text-xs text-blue-700 font-medium mb-1">üìä ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå:</div>
            <div className="text-xs text-blue-600 space-y-0.5">
              <div>‚Ä¢ OECD Better Life Index 2024 ‚Äî ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</div>
              <div>‚Ä¢ Numbeo Cost of Living Index 2025 ‚Äî ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡∏ä‡∏µ‡∏û ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏°‡∏∑‡∏≠‡∏á</div>
              <div>‚Ä¢ Global Peace Index 2024 ‚Äî ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</div>
              <div>‚Ä¢ UNDP Human Development Report 2024 ‚Äî ‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå</div>
              <div>‚Ä¢ IMF World Economic Outlook 2025 ‚Äî GDP, ‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à</div>
            </div>
          </div>
          <div className="mt-2 bg-amber-50 border border-amber-200 rounded-xl p-3">
            <div className="text-xs text-amber-700">
              ‚ö†Ô∏è <strong>‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</strong> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠
              ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ ‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
              ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à
            </div>
          </div>

          {/* Links to other tabs */}
          <div className="flex flex-col sm:flex-row gap-2 mt-3 mb-1">
            <a href={`${basePath}/sim`} className="flex-1 py-3 rounded-xl bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 text-center text-sm text-green-700 font-medium hover:shadow-md transition-all">
              üá¶üá∫ ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÉ‡∏ô‡∏≠‡∏≠‡∏™ ‚Üí
            </a>
            <a href={`${basePath}/visa`} className="flex-1 py-3 rounded-xl bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 text-center text-sm text-orange-700 font-medium hover:shadow-md transition-all">
              üìã ‡∏î‡∏π‡∏ß‡∏µ‡∏ã‡πà‡∏≤ & ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‚Üí
            </a>
          </div>

          <button onClick={restart} className="w-full mt-2 mb-2 py-3 rounded-xl border-2 border-gray-200 text-gray-500 hover:bg-gray-50 text-sm font-medium">
            üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
          </button>

          <div className="mb-4">
            <ShareButtons />
          </div>

          <div ref={bottomRef} />
        </div>
      </div>
    )
  }

  // ================================================================
  // ===== RENDER: AU PROFILE =====
  // ================================================================
  if (phase === 'auProfile') {
    return (
      <div className="sim-container">
        <div className="sim-scroll">
          <div className="text-center mb-4 animate-fade-in">
            <div className="text-4xl mb-2">üá¶üá∫</div>
            <div className="text-xl font-bold text-gray-800">‡∏°‡∏≤‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏™‡∏Å‡∏±‡∏ô!</div>
            <div className="text-sm text-gray-500 mt-1">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì visa + ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡∏ä‡∏µ‡∏û‡∏à‡∏£‡∏¥‡∏á</div>
          </div>

          <div className="stage-card animate-fade-in">
            <div className="stage-body space-y-3">
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="form-label">üó£Ô∏è IELTS/PTE</label>
                  <select className="form-select" value={auProfile.english} onChange={e => upAU('english', e.target.value)}>
                    <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option>
                    <option value="superior">8.0+ Superior</option>
                    <option value="proficient">7.0 Proficient</option>
                    <option value="competent">6.0 Competent</option>
                    <option value="low">‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 6</option>
                  </select>
                </div>
                <div>
                  <label className="form-label">üí™ ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå</label>
                  <select className="form-select" value={auProfile.experience} onChange={e => upAU('experience', e.target.value)}>
                    <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option>
                    <option value="0-2">0-2 ‡∏õ‡∏µ</option>
                    <option value="3-4">3-4 ‡∏õ‡∏µ</option>
                    <option value="5-7">5-7 ‡∏õ‡∏µ</option>
                    <option value="8+">8+ ‡∏õ‡∏µ</option>
                  </select>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="form-label">üéì ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                  <select className="form-select" value={auProfile.education} onChange={e => upAU('education', e.target.value)}>
                    <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî</option>
                    <option value="phd">‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡πÄ‡∏≠‡∏Å</option>
                    <option value="masters">‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡πÇ‡∏ó</option>
                    <option value="bachelor">‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡∏ï‡∏£‡∏µ</option>
                    <option value="diploma">‡∏õ‡∏ß‡∏™./Diploma</option>
                    <option value="highschool">‡∏°.6 ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤</option>
                  </select>
                </div>
                <div>
                  <label className="form-label">üèôÔ∏è ‡πÄ‡∏°‡∏∑‡∏≠‡∏á</label>
                  <select className="form-select" value={auProfile.city} onChange={e => upAU('city', e.target.value)}>
                    <option value="sydney">üèôÔ∏è Sydney</option>
                    <option value="melbourne">üé≠ Melbourne</option>
                    <option value="brisbane">‚òÄÔ∏è Brisbane</option>
                  </select>
                </div>
              </div>

              <div>
                <label className="form-label">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏ó‡∏¢‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                <input type="number" className="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 45000"
                  value={auProfile.thaiSalary} onChange={e => upAU('thaiSalary', e.target.value)} />
              </div>

              {allAuFilled && (
                <button onClick={startSim} className="btn-primary w-full mt-2 justify-center rounded-xl py-4 text-lg animate-fade-in">
                  üéÆ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢!
                </button>
              )}
            </div>
          </div>

          <button onClick={() => setPhase('countryResults')} className="w-full mt-3 py-2 text-sm text-gray-500 hover:text-gray-700">
            ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡∏π‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏≠‡∏∑‡πà‡∏ô
          </button>

          <div ref={bottomRef} />
        </div>
      </div>
    )
  }

  // ================================================================
  // ===== RENDER: SIMULATION (GAME STAGES) =====
  // ================================================================
  const allDone = simStage >= TOTAL_STAGES

  return (
    <div className="sim-container">
      {/* Balance bar */}
      <div className={`balance-bar ${isMotherLord ? 'motherlord' : balanceAUD < 0 ? 'negative' : ''}`}>
        {isMotherLord ? (
          <span>üè¶ <strong>MOTHERLORD MODE</strong> üí∞ ‚àû</span>
        ) : (
          <span>üè¶ ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <strong>{fmtAud(balanceAUD)}</strong> <span className="bal-thb">({fmtThb(Math.round(balanceAUD * AUD_TO_THB))})</span></span>
        )}
      </div>

      <div className="sim-scroll sim-scroll-with-bar">
        {/* Progress */}
        <div className="stage-progress">
          {STAGE_META.map((_, i) => (
            <div key={i} className={`stage-dot ${i < simStage ? 'done' : i === simStage ? 'current' : ''}`} />
          ))}
        </div>

        {/* ===== COMPLETED STAGES ===== */}
        {simStage >= 1 && <Completed emoji="üí∞" title="‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏£‡∏∞‡∏™‡∏∏‡∏ô" detail={isMotherLord ? 'MOTHERLORD ‚àû' : `${fmtThb(parseInt(savingsInput) || 0)} = ${fmtAud(initialAUD)}`} />}
        {simStage >= 2 && <Completed emoji="üìã" title="‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏¥‡∏ô" detail={`-${fmtAud(preDepartureTotal)}`} negative />}
        {simStage > 2 && choices['job'] && <Completed emoji="üíº" title="‡πÑ‡∏î‡πâ‡∏á‡∏≤‡∏ô" detail={`${fmtAud(grossAnnual)}/‡∏õ‡∏µ (${choices['job'] === 'top' ? 'üëë Top' : choices['job'] === 'min' ? '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥' : 'Average'})`} />}
        {simStage > 3 && choices['flight'] && <Completed emoji="‚úàÔ∏è" title="‡∏ï‡∏±‡πã‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô" detail={choices['flight'] === 'company' ? '‡∏ü‡∏£‡∏µ! ‡∏ö.‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ' : `-${fmtAud(flightCost)}`} negative={choices['flight'] !== 'company'} />}
        {simStage > 4 && choices['temp'] && <Completed emoji="üè®" title="‡∏û‡∏±‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß" detail={choices['temp'] === 'friend' ? '‡∏ü‡∏£‡∏µ!' : `-${fmtAud(tempCost)}`} negative={choices['temp'] !== 'friend'} />}
        {simStage > 5 && choices['housing'] && <Completed emoji="üè†" title="‡∏ö‡πâ‡∏≤‡∏ô" detail={`‡∏°‡∏±‡∏î‡∏à‡∏≥ -${fmtAud(bond)} + ${fmtAud(monthlyRent)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`} negative />}
        {simStage > 6 && choices['furnish'] && <Completed emoji="üõãÔ∏è" title="‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô" detail={furnishCost === 0 ? 'Furnished! $0' : `-${fmtAud(furnishCost)}`} negative={furnishCost > 0} />}
        {simStage > 7 && choices['commute'] && <Completed emoji="üöó" title="‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" detail={`${fmtAud(monthlyTransport)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`} />}
        {simStage > 8 && choices['food'] && <Completed emoji="üç≥" title="‡∏≠‡∏≤‡∏´‡∏≤‡∏£" detail={`${fmtAud(monthlyFood)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`} />}
        {simStage > 9 && choices['insurance'] && <Completed emoji="üè•" title="‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô" detail={monthlyInsurance > 0 ? '$150/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : '‡∏ü‡∏£‡∏µ!'} />}

        {/* ===== CURRENT STAGE ===== */}
        {!allDone && phase === 'sim' && (
          <div className="stage-card animate-fade-in">
            <div className="stage-header">
              <div className="text-lg font-bold text-gray-800">{STAGE_META[simStage].title}</div>
              <div className="text-sm text-gray-500">{STAGE_META[simStage].sub}</div>
            </div>
            <div className="stage-body">
              {simStage === 0 && (
                <div className="space-y-3">
                  <div>
                    <label className="form-label">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö (‡∏ö‡∏≤‡∏ó)</label>
                    <input type="number" className="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 500000"
                      value={savingsInput} onChange={e => setSavingsInput(e.target.value)} />
                    {savingsInput && <div className="text-xs text-gray-500 mt-1">= {fmtAud(Math.round((parseInt(savingsInput) || 0) / AUD_TO_THB))} AUD</div>}
                  </div>
                  {savingsInput && <button onClick={() => commitSavings(false)} className="stage-option-btn">‚úÖ ‡∏°‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö {fmtThb(parseInt(savingsInput))} ‚Äî ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢!</button>}
                  <button onClick={() => commitSavings(true)} className="stage-option-btn motherlord-btn">ü§ë 9,999,999 MOTHERLORD ‚Äî ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î!</button>
                </div>
              )}
              {simStage === 1 && (
                <div>
                  <div className="text-sm text-gray-600 mb-3">‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ:</div>
                  {preDepartureCosts.map((c, i) => (
                    <div key={i} className="flex justify-between py-1.5 text-sm border-b border-gray-100">
                      <span>{c.label}</span>
                      <span className="font-mono text-red-500">-{fmtAud(c.aud)}</span>
                    </div>
                  ))}
                  <div className="flex justify-between py-2 font-bold border-t-2 border-gray-200 mt-2">
                    <span>‡∏£‡∏ß‡∏°</span><span className="text-red-600">-{fmtAud(preDepartureTotal)}</span>
                  </div>
                  <div className="text-xs text-gray-400 mt-1 mb-3">‚âà {fmtThb(Math.round(preDepartureTotal * AUD_TO_THB))}</div>
                  <button onClick={advanceStage} className="stage-option-btn">üí≥ ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏¢! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏≤‡∏á‡∏ñ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß üî•</button>
                </div>
              )}
              {simStage === 2 && (
                <div className="space-y-2">
                  <Opt onClick={() => pick('job', 'avg')}><div className="font-semibold">üíº ‡πÑ‡∏î‡πâ‡∏á‡∏≤‡∏ô {salaryData.label} ‚Äî Average</div><div className="text-sm text-gray-500">{fmtAud(salaryData.mid)}/‡∏õ‡∏µ ‚âà {fmtThb(Math.round(salaryData.mid / 12 * AUD_TO_THB))}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div></Opt>
                  <Opt onClick={() => pick('job', 'top')}><div className="font-semibold">üëë ‡∏â‡∏±‡∏ô‡πÄ‡∏ó‡∏û! Top Salary</div><div className="text-sm text-gray-500">{fmtAud(salaryData.senior)}/‡∏õ‡∏µ</div></Opt>
                  <Opt onClick={() => pick('job', 'min')}><div className="font-semibold">üòÖ ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡πá‡πÑ‡∏î‡πâ Minimum wage</div><div className="text-sm text-gray-500">{fmtAud(AU_UNSKILLED_SALARY)}/‡∏õ‡∏µ</div></Opt>
                </div>
              )}
              {simStage === 3 && (
                <div className="space-y-2">
                  <Opt onClick={() => pick('flight', 'business')}><div className="font-semibold">‚úàÔ∏è Business Class</div><div className="text-sm text-red-500">-{fmtAud(quickProfile.family === 'single' ? 4500 : quickProfile.family === 'couple' ? 9000 : 13500)} <span className="text-gray-400">({fmtThb(Math.round((quickProfile.family === 'single' ? 4500 : quickProfile.family === 'couple' ? 9000 : 13500) * AUD_TO_THB))})</span></div></Opt>
                  <Opt onClick={() => pick('flight', 'economy')}><div className="font-semibold">ü™ë Economy</div><div className="text-sm text-red-500">-{fmtAud(quickProfile.family === 'single' ? 1100 : quickProfile.family === 'couple' ? 2200 : 3500)} <span className="text-gray-400">({fmtThb(Math.round((quickProfile.family === 'single' ? 1100 : quickProfile.family === 'couple' ? 2200 : 3500) * AUD_TO_THB))})</span></div></Opt>
                  <Opt onClick={() => pick('flight', 'company')}><div className="font-semibold">üè¢ ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ!</div><div className="text-sm text-green-600">‡∏ü‡∏£‡∏µ! $0</div></Opt>
                </div>
              )}
              {simStage === 4 && (
                <div className="space-y-2">
                  <div className="text-sm text-gray-600 mb-1">‡∏ñ‡∏∂‡∏á {city.name} ‡πÅ‡∏•‡πâ‡∏ß!</div>
                  <Opt onClick={() => pick('temp', 'airbnb')}><div className="font-semibold">üè® Airbnb</div><div className="text-sm text-red-500">-$2,100 (14 ‡∏Ñ‡∏∑‡∏ô) <span className="text-gray-400">({fmtThb(Math.round(2100 * AUD_TO_THB))})</span></div></Opt>
                  <Opt onClick={() => pick('temp', 'hostel')}><div className="font-semibold">üõèÔ∏è Hostel</div><div className="text-sm text-red-500">-$700 (14 ‡∏Ñ‡∏∑‡∏ô) <span className="text-gray-400">({fmtThb(Math.round(700 * AUD_TO_THB))})</span></div></Opt>
                  <Opt onClick={() => pick('temp', 'friend')}><div className="font-semibold">üè† ‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô/‡∏ç‡∏≤‡∏ï‡∏¥</div><div className="text-sm text-green-600">‡∏ü‡∏£‡∏µ!</div></Opt>
                </div>
              )}
              {simStage === 5 && (
                <div className="space-y-2">
                  <div className="text-sm text-gray-600 mb-1">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ {city.name}:</div>
                  <Opt onClick={() => pick('housing', 'share')}><div className="font-semibold">üè† ‡πÅ‡∏ä‡∏£‡πå‡∏ö‡πâ‡∏≤‡∏ô</div><div className="text-sm text-gray-500">{fmtAud(city.rentShare)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span className="text-gray-400">({fmtThb(Math.round(city.rentShare * AUD_TO_THB))})</span></div></Opt>
                  <Opt onClick={() => pick('housing', '1bed')}><div className="font-semibold">üè¢ 1 ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô</div><div className="text-sm text-gray-500">{fmtAud(city.rent1br)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span className="text-gray-400">({fmtThb(Math.round(city.rent1br * AUD_TO_THB))})</span></div></Opt>
                  <Opt onClick={() => pick('housing', '2bed')}><div className="font-semibold">üè¢ 2 ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô</div><div className="text-sm text-gray-500">{fmtAud(quickProfile.family === 'family' ? city.rentFamily : city.rent2br)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span className="text-gray-400">({fmtThb(Math.round((quickProfile.family === 'family' ? city.rentFamily : city.rent2br) * AUD_TO_THB))})</span></div></Opt>
                </div>
              )}
              {simStage === 6 && (
                <div className="space-y-2">
                  <Opt onClick={() => pick('furnish', 'ikea')}><div className="font-semibold">ü™ë IKEA ‡∏ä‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div><div className="text-sm text-red-500">-$2,000 <span className="text-gray-400">({fmtThb(Math.round(2000 * AUD_TO_THB))})</span></div></Opt>
                  <Opt onClick={() => pick('furnish', 'nice')}><div className="font-semibold">‚ú® ‡∏à‡∏±‡∏î‡πÄ‡∏ï‡πá‡∏°</div><div className="text-sm text-red-500">-$4,000 <span className="text-gray-400">({fmtThb(Math.round(4000 * AUD_TO_THB))})</span></div></Opt>
                  <Opt onClick={() => pick('furnish', 'second')}><div className="font-semibold">‚ôªÔ∏è ‡∏°‡∏∑‡∏≠‡∏™‡∏≠‡∏á</div><div className="text-sm text-red-500">-$800 <span className="text-gray-400">({fmtThb(Math.round(800 * AUD_TO_THB))})</span></div></Opt>
                  <Opt onClick={() => pick('furnish', 'furnished')}><div className="font-semibold">üè¢ Furnished ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡∏∑‡πâ‡∏≠!</div><div className="text-sm text-green-600">$0</div></Opt>
                </div>
              )}
              {simStage === 7 && (
                <div className="space-y-2">
                  <Opt onClick={() => pick('commute', 'car')}><div className="font-semibold">üöó ‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ‡πÄ‡∏≠‡∏á</div><div className="text-sm text-gray-500">{fmtAud(TRANSPORT_COSTS['car'].cost)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span className="text-gray-400">({fmtThb(Math.round(TRANSPORT_COSTS['car'].cost * AUD_TO_THB))})</span></div><div className="text-[10px] text-gray-400">{TRANSPORT_COSTS['car'].breakdown}</div></Opt>
                  <Opt onClick={() => pick('commute', 'mixed')}><div className="font-semibold">üöóüöá ‡∏ú‡∏™‡∏°</div><div className="text-sm text-gray-500">{fmtAud(TRANSPORT_COSTS['mixed'].cost)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span className="text-gray-400">({fmtThb(Math.round(TRANSPORT_COSTS['mixed'].cost * AUD_TO_THB))})</span></div></Opt>
                  <Opt onClick={() => pick('commute', 'public')}><div className="font-semibold">üöá ‡∏£‡∏ñ‡πÑ‡∏ü/‡∏£‡∏ñ‡πÄ‡∏°‡∏•‡πå</div><div className="text-sm text-gray-500">{fmtAud(TRANSPORT_COSTS['public'].cost)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span className="text-gray-400">({fmtThb(Math.round(TRANSPORT_COSTS['public'].cost * AUD_TO_THB))})</span></div></Opt>
                </div>
              )}
              {simStage === 8 && (
                <div className="space-y-2">
                  <Opt onClick={() => pick('food', 'always')}><div className="font-semibold">üë®‚Äçüç≥ ‡∏ó‡∏≥‡πÄ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏°‡∏∑‡πâ‡∏≠</div><div className="text-sm text-gray-500">{fmtAud(FOOD_COSTS['always'].cost)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span className="text-gray-400">({fmtThb(Math.round(FOOD_COSTS['always'].cost * AUD_TO_THB))})</span></div></Opt>
                  <Opt onClick={() => pick('food', 'often')}><div className="font-semibold">üç≥ ‡∏ó‡∏≥‡πÄ‡∏≠‡∏á+‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏¥‡∏Å‡∏ã‡πå</div><div className="text-sm text-gray-500">{fmtAud(FOOD_COSTS['often'].cost)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span className="text-gray-400">({fmtThb(Math.round(FOOD_COSTS['often'].cost * AUD_TO_THB))})</span></div></Opt>
                  <Opt onClick={() => pick('food', 'sometimes')}><div className="font-semibold">ü•° ‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏¥‡∏ô‡∏ö‡πà‡∏≠‡∏¢</div><div className="text-sm text-gray-500">{fmtAud(FOOD_COSTS['sometimes'].cost)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span className="text-gray-400">({fmtThb(Math.round(FOOD_COSTS['sometimes'].cost * AUD_TO_THB))})</span></div></Opt>
                  <Opt onClick={() => pick('food', 'rarely')}><div className="font-semibold">üõµ Uber Eats ‡∏ó‡∏∏‡∏Å‡∏°‡∏∑‡πâ‡∏≠</div><div className="text-sm text-gray-500">{fmtAud(FOOD_COSTS['rarely'].cost)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span className="text-gray-400">({fmtThb(Math.round(FOOD_COSTS['rarely'].cost * AUD_TO_THB))})</span></div></Opt>
                </div>
              )}
              {simStage === 9 && (
                <div className="space-y-2">
                  <Opt onClick={() => pick('insurance', 'medicare')}><div className="font-semibold">üè• Medicare ‡πÄ‡∏â‡∏¢‡πÜ (‡∏ü‡∏£‡∏µ!)</div><div className="text-sm text-green-600">$0/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div></Opt>
                  <Opt onClick={() => pick('insurance', 'private')}><div className="font-semibold">üè•+ Medicare + ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô</div><div className="text-sm text-gray-500">$150/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div></Opt>
                  <Opt onClick={() => pick('insurance', 'company')}><div className="font-semibold">üíº ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏≥‡πÉ‡∏´‡πâ!</div><div className="text-sm text-green-600">$0/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div></Opt>
                </div>
              )}
            </div>
          </div>
        )}

        {/* ===== ALL STAGES DONE: COST SUMMARY ===== */}
        {allDone && phase === 'sim' && (
          <div className="animate-fade-in space-y-4">
            <div className="stage-card">
              <div className="stage-header"><div className="text-lg font-bold text-gray-800">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
              <div className="stage-body">
                <SumRow label="üìã ‡∏ß‡∏µ‡∏ã‡πà‡∏≤+‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£+‡∏™‡∏≠‡∏ö+‡∏ï‡∏£‡∏ß‡∏à" aud={preDepartureTotal} />
                <SumRow label="‚úàÔ∏è ‡∏ï‡∏±‡πã‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ö‡∏¥‡∏ô" aud={flightCost} />
                <SumRow label="üè® ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß" aud={tempCost} />
                <SumRow label="üè† ‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ö‡πâ‡∏≤‡∏ô" aud={bond} />
                <SumRow label="üõãÔ∏è ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô" aud={furnishCost} />
                <div className="flex justify-between py-2 font-bold border-t-2 border-gray-300 mt-2">
                  <span>‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡πâ‡∏ô</span><span className="text-red-600">-{fmtAud(finalOneTime)}</span>
                </div>
                <div className="text-xs text-gray-500 mb-3">‚âà {fmtThb(Math.round(finalOneTime * AUD_TO_THB))}</div>
                <div className={`p-4 rounded-xl text-center ${isMotherLord ? 'bg-yellow-50 border-2 border-yellow-300' : (initialAUD - finalOneTime) >= 0 ? 'bg-green-50 border-2 border-green-200' : 'bg-red-50 border-2 border-red-200'}`}>
                  <div className="text-sm text-gray-600">{isMotherLord ? 'ü§ë MOTHERLORD MODE' : 'üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏à‡πà‡∏≤‡∏¢'}</div>
                  <div className={`text-2xl font-bold ${isMotherLord ? 'text-yellow-600' : (initialAUD - finalOneTime) >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    {isMotherLord ? '‚àû' : fmtAud(initialAUD - finalOneTime)}
                  </div>
                  {!isMotherLord && (initialAUD - finalOneTime) < 0 && <div className="text-sm text-red-600 mt-1">‚ö†Ô∏è ‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠! ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å {fmtAud(Math.abs(initialAUD - finalOneTime))}</div>}
                </div>
              </div>
            </div>
            <button onClick={() => setPhase('result')} className="btn-primary w-full justify-center rounded-xl py-4 text-lg">üéä ‡∏î‡∏π‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô!</button>
          </div>
        )}

        {/* ================================================================ */}
        {/* ===== RESULT PHASE ===== */}
        {/* ================================================================ */}
        {phase === 'result' && (
          <div className="animate-fade-in space-y-4">
            <div className="text-center py-2">
              <div className="text-3xl font-bold text-gray-800 mb-1">üéä ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!</div>
              <div className="text-lg text-blue-600 font-semibold">‡∏Ñ‡∏∏‡∏ì‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ {city.name}, Australia ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
            </div>

            {/* Monthly Breakdown */}
            <div className="result-section">
              <h4 className="text-base font-bold text-gray-800 mb-2">üíµ ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h4>
              <div className="text-xs text-gray-400 uppercase tracking-wide mb-1">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
              <Row label={`‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Gross) ‚Äî ${choices['job'] === 'top' ? 'üëë Top' : choices['job'] === 'min' ? '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥' : 'Average'}`} val={fmtAud(Math.round(grossAnnual / 12))} />
              <Row label={`‡∏†‡∏≤‡∏©‡∏µ (${auTax.effectiveRate}%)`} val={`-${fmtAud(Math.round(auTax.tax / 12))}`} red />
              <Row label="Medicare 2%" val={`-${fmtAud(Math.round(auTax.medicare / 12))}`} red />
              <div className="flex justify-between py-2 font-bold text-green-700 border-t border-gray-200">
                <span>üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ Net</span><span>{fmtAud(monthlyNet)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
              </div>
              <div className="text-xs text-gray-400 mb-3">+ Super {fmtAud(Math.round(grossAnnual * 0.115 / 12))}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢ 11.5%)</div>
              <div className="text-xs text-gray-400 uppercase tracking-wide mb-1">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
              <Row label={`üè† ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ (${choices['housing'] === 'share' ? '‡πÅ‡∏ä‡∏£‡πå' : choices['housing'] === '1bed' ? '1 bed' : '2 bed'})`} val={`-${fmtAud(monthlyRent)}`} red />
              <Row label="üí° ‡∏ô‡πâ‡∏≥/‡πÑ‡∏ü+Internet" val={`-${fmtAud(monthlyUtils)}`} red />
              <Row label="üç≥ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£" val={`-${fmtAud(monthlyFood)}`} red />
              <Row label="üöá ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á" val={`-${fmtAud(monthlyTransport)}`} red />
              <Row label="üì± ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠" val={`-${fmtAud(monthlyPhone)}`} red />
              {monthlyInsurance > 0 && <Row label="üè• ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°" val={`-${fmtAud(monthlyInsurance)}`} red />}
              <Row label="üé¨ ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß/‡∏™‡∏±‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå" val={`-${fmtAud(monthlyMisc)}`} red />
              <Row label="üè• Medicare" val="‡∏ü‡∏£‡∏µ!" green />
              <div className="flex justify-between py-2 font-bold border-t-2 border-gray-300 mt-1">
                <span>‡∏£‡∏ß‡∏°‡∏à‡πà‡∏≤‡∏¢</span><span className="text-red-600">-{fmtAud(totalMonthlyExp)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
              </div>
            </div>

            {/* Net Savings */}
            <div className={`p-5 rounded-xl text-center ${monthlySavings >= 0 ? 'bg-green-50 border-2 border-green-200' : 'bg-red-50 border-2 border-red-200'}`}>
              <div className="text-sm text-gray-600 mb-1">üí∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
              <div className={`text-3xl font-bold ${monthlySavings >= 0 ? 'text-green-600' : 'text-red-600'}`}>{fmtAud(monthlySavings)} AUD</div>
              <div className={`text-lg font-semibold ${monthlySavings >= 0 ? 'text-green-500' : 'text-red-500'}`}>‚âà {fmtThb(monthlySavingsTHB)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
              {monthlySavings > 0 && <div className="text-xs text-gray-500 mt-1">1 ‡∏õ‡∏µ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ ~{fmtThb(monthlySavingsTHB * 12)}</div>}
            </div>

            {/* Fun spend */}
            {monthlySavings > 0 && (
              <div className="bg-purple-50 border border-purple-200 rounded-xl p-4 text-sm">
                <div className="font-bold text-purple-800 mb-2">üéâ ‡πÄ‡∏á‡∏¥‡∏ô {fmtAud(monthlySavings)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ?</div>
                <div className="space-y-1 text-purple-700">
                  <div>üç£ ‡∏Å‡∏¥‡∏ô‡∏ã‡∏π‡∏ä‡∏¥ $30 ‡πÑ‡∏î‡πâ {Math.round(monthlySavings / 30)} ‡∏°‡∏∑‡πâ‡∏≠</div>
                  <div>‚úàÔ∏è ‡∏ï‡∏±‡πã‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏ó‡∏¢ (~$600) ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å {(600 / monthlySavings).toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                  <div>üì± ‡∏ã‡∏∑‡πâ‡∏≠ iPhone ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å {(1899 / monthlySavings).toFixed(1)} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                  <div>üè¶ 1 ‡∏õ‡∏µ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ ~{fmtThb(monthlySavingsTHB * 12)}</div>
                </div>
              </div>
            )}

            {/* TH vs AU */}
            <div className="result-section" style={{ background: 'linear-gradient(135deg, #FFF7ED, #FEF9C3)', borderColor: '#FDBA74' }}>
              <h4 className="text-base font-bold text-gray-800 mb-3">üî• ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ô: ‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏ó‡∏¢ vs ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ AU</h4>
              <div className="grid grid-cols-2 gap-3">
                <div className="text-center p-3 bg-white/70 rounded-lg">
                  <div className="text-2xl">üáπüá≠</div>
                  <div className="font-bold text-gray-800 text-sm">‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏ó‡∏¢</div>
                  <div className="text-xs text-gray-500">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô {fmtThb(thaiSalary)}</div>
                  <div className="text-xl font-bold text-orange-600 mt-1">{fmtThb(thaiMonthlySavings)}</div>
                </div>
                <div className="text-center p-3 bg-white/70 rounded-lg">
                  <div className="text-2xl">üá¶üá∫</div>
                  <div className="font-bold text-gray-800 text-sm">‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ AU</div>
                  <div className="text-xs text-gray-500">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô {fmtAud(Math.round(grossAnnual / 12))}</div>
                  <div className="text-xl font-bold text-green-600 mt-1">{fmtThb(monthlySavingsTHB)}</div>
                </div>
              </div>
              {monthlySavingsTHB > thaiMonthlySavings && (
                <div className="text-center mt-3 p-2 bg-green-100 rounded-lg">
                  <span className="text-green-700 font-bold text-sm">üìà ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ +{fmtThb(monthlySavingsTHB - thaiMonthlySavings)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô!</span>
                </div>
              )}
              <div className="mt-3 text-xs text-orange-700 space-y-1">
                <div>üè• + Medicare ‡∏ü‡∏£‡∏µ</div>
                <div>üèñÔ∏è + Annual Leave 20 ‡∏ß‡∏±‡∏ô</div>
                <div>ü§í + Sick Leave 10 ‡∏ß‡∏±‡∏ô</div>
                <div>üè¶ + Super 11.5% ‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢</div>
                <div>üë∂ + Parental Leave 18 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
              </div>
            </div>

            {/* Tax section */}
            <div className="result-section" style={{ background: 'linear-gradient(135deg, #FEF2F2, #FCE7F3)', borderColor: '#FCA5A5' }}>
              <h4 className="text-base font-bold text-gray-800 mb-2">üòè ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ö‡∏≠‡∏Å &ldquo;‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£&rdquo;</h4>
              <div className="text-sm text-gray-700 space-y-2">
                <div>‡∏†‡∏≤‡∏©‡∏µ+Medicare ‡∏ó‡∏µ‡πà AU: {auTax.effectiveRate}% ‚âà {fmtAud(Math.round((auTax.tax + auTax.medicare) / 12))}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
                <div className="font-semibold text-red-700">
                  {monthlySavingsTHB > thaiMonthlySavings
                    ? `üí° ‡∏à‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏µ "‡πÄ‡∏¢‡∏≠‡∏∞" ‡πÅ‡∏ï‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏ó‡∏¢ +${fmtThb(monthlySavingsTHB - thaiMonthlySavings)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`
                    : 'üí° ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡πÇ‡∏Å‡∏´‡∏Å ‡∏•‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÄ‡∏≠‡∏á'}
                </div>
              </div>
            </div>

            {/* Visa Score */}
            <div className="result-section">
              <h4 className="text-base font-bold text-gray-800 mb-2">üìã ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ß‡∏µ‡∏ã‡πà‡∏≤ Skilled Migration (‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô)</h4>
              <div className={`p-3 rounded-lg ${visa.score >= 65 ? 'bg-green-50 border border-green-200' : visa.score >= 50 ? 'bg-yellow-50 border border-yellow-200' : 'bg-red-50 border border-red-200'}`}>
                <div className="flex justify-between items-center">
                  <span className="font-semibold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</span>
                  <span className={`text-xl font-bold ${visa.score >= 65 ? 'text-green-600' : 'text-yellow-600'}`}>{visa.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                </div>
                <div className="text-xs text-gray-600 mt-2 space-y-0.5">
                  {visa.details.map((d, i) => <div key={i}>‚Ä¢ {d}</div>)}
                </div>
                <div className="text-xs text-gray-400 mt-2">* ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° Partner/‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô AU/NAATI</div>
                {visa.score >= 65 ? <div className="text-sm text-green-700 font-semibold mt-2">‚úÖ ‡∏ú‡πà‡∏≤‡∏ô 65! ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ 189/190 ‡πÑ‡∏î‡πâ</div>
                  : visa.score >= 50 ? <div className="text-sm text-yellow-700 font-semibold mt-2">‚ö†Ô∏è ‡∏•‡∏≠‡∏á 491 Regional (+15) = {visa.score + 15}</div>
                  : <div className="text-sm text-red-700 font-semibold mt-2">‚ùå ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Skilled ‡∏ï‡πà‡∏≥ ‚Äî ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô! ‡∏î‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á üëá</div>}
              </div>
            </div>

            {/* Non-points visa pathways */}
            <div className="result-section" style={{ background: 'linear-gradient(135deg, #F0FDF4, #ECFDF5)', borderColor: '#86EFAC' }}>
              <h4 className="text-base font-bold text-gray-800 mb-2">üé´ ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h4>
              <div className="text-sm text-gray-700 space-y-3">
                <div className="p-2 bg-white/80 rounded-lg">
                  <div className="font-semibold text-green-700">üíº Employer Sponsored (482/186)</div>
                  <div className="text-xs text-gray-600">‡∏´‡∏≤‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á AU sponsor ‡πÉ‡∏´‡πâ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏ó‡∏≥ 2-3 ‡∏õ‡∏µ ‚Üí PR ‡πÑ‡∏î‡πâ</div>
                  <div className="text-xs text-gray-400">‡∏Ñ‡πà‡∏≤‡∏ß‡∏µ‡∏ã‡πà‡∏≤ ~$3,035</div>
                </div>
                <div className="p-2 bg-white/80 rounded-lg">
                  <div className="font-semibold text-blue-700">üéì Student ‚Üí Graduate (500 ‚Üí 485)</div>
                  <div className="text-xs text-gray-600">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà AU ‚Üí ‡∏à‡∏ö‡πÑ‡∏î‡πâ work visa 2-4 ‡∏õ‡∏µ ‚Üí ‡∏´‡∏≤‡∏á‡∏≤‡∏ô ‚Üí apply PR</div>
                  <div className="text-xs text-gray-400">‡∏Ñ‡πà‡∏≤‡∏ß‡∏µ‡∏ã‡πà‡∏≤ $1,600 + ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏≠‡∏° $20,000-50,000/‡∏õ‡∏µ</div>
                </div>
                {(() => {
                  const ageN = quickProfile.age === '18-24' ? 21 : quickProfile.age === '25-32' ? 28 : 36
                  return ageN <= 30 ? (
                    <div className="p-2 bg-white/80 rounded-lg border-2 border-orange-200">
                      <div className="font-semibold text-orange-700">üèñÔ∏è Working Holiday (462) ‚Äî ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå!</div>
                      <div className="text-xs text-gray-600">‡πÑ‡∏ó‡∏¢‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡∏Å‡∏±‡∏ö AU! ‡∏≠‡∏≤‡∏¢‡∏∏ 18-30 ‡πÑ‡∏õ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô+‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á 3 ‡∏õ‡∏µ</div>
                      <div className="text-xs text-gray-400">‡∏Ñ‡πà‡∏≤‡∏ß‡∏µ‡∏ã‡πà‡∏≤ $640 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!</div>
                    </div>
                  ) : (
                    <div className="p-2 bg-white/80 rounded-lg opacity-60">
                      <div className="font-semibold text-orange-700">üèñÔ∏è Working Holiday (462)</div>
                      <div className="text-xs text-gray-500">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏ 18-30 ‡∏õ‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)</div>
                    </div>
                  )
                })()}
                <div className="p-2 bg-white/80 rounded-lg">
                  <div className="font-semibold text-pink-700">üíë Partner Visa (309/820)</div>
                  <div className="text-xs text-gray-600">‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™/‡πÅ‡∏ü‡∏ô‡πÄ‡∏õ‡πá‡∏ô AU citizen/PR ‚Üí ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‚Üí PR ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 2 ‡∏õ‡∏µ</div>
                  <div className="text-xs text-gray-400">‡∏Ñ‡πà‡∏≤‡∏ß‡∏µ‡∏ã‡πà‡∏≤ $9,095 (‡πÅ‡∏û‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)</div>
                </div>
              </div>
              <div className="mt-2 text-xs text-gray-500">
                <a href={`${basePath}/visa`} className="text-blue-600 underline font-medium">‚Üí ‡∏î‡∏π‡∏ß‡∏µ‡∏ã‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î + ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</a>
              </div>
            </div>

            {/* Tips */}
            <div className="result-section" style={{ background: '#EFF6FF', borderColor: '#93C5FD' }}>
              <h4 className="text-base font-bold text-gray-800 mb-2">üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö</h4>
              <div className="text-sm text-gray-700 space-y-2">
                {choices['job'] === 'min' && <div>üìà <strong>‡∏´‡∏≤‡∏á‡∏≤‡∏ô Professional:</strong> Skilled Visa ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ 2-3 ‡πÄ‡∏ó‡πà‡∏≤</div>}
                {choices['housing'] !== 'share' && <div>üè† <strong>‡πÅ‡∏ä‡∏£‡πå‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏á 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å:</strong> ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÑ‡∏î‡πâ {fmtAud(monthlyRent - city.rentShare)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>}
                {choices['commute'] === 'car' && <div>üöá <strong>‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÑ‡∏ü‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏£‡∏Å:</strong> ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î {fmtAud(TRANSPORT_COSTS['car'].cost - TRANSPORT_COSTS['public'].cost)}/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>}
                <div>üìã <strong>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</strong> ‡∏™‡∏≠‡∏ö IELTS ‚Üí Skills Assessment ‚Üí ‡∏¢‡∏∑‡πà‡∏ô EOI ‚Üí Invitation ‚Üí ‡∏ß‡∏µ‡∏ã‡πà‡∏≤ ‚Üí ‡∏ö‡∏¥‡∏ô‡πÑ‡∏õ!</div>
              </div>
            </div>

            {/* Detailed Sources */}
            <div className="mt-4 bg-blue-50 border border-blue-200 rounded-xl p-3">
              <div className="text-xs text-blue-700 font-medium mb-1">üìä ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:</div>
              <div className="text-xs text-blue-600 space-y-0.5">
                <div>‚Ä¢ <a href="https://immi.homeaffairs.gov.au/visas/working-in-australia/skillselect" target="_blank" rel="noopener noreferrer" className="underline">Home Affairs SkillSelect</a> ‚Äî ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ß‡∏µ‡∏ã‡πà‡∏≤ ‡∏Ñ‡πà‡∏≤‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏°</div>
                <div>‚Ä¢ <a href="https://www.ato.gov.au/tax-rates-and-codes/tax-rates-resident" target="_blank" rel="noopener noreferrer" className="underline">ATO Tax Rates FY 2025-26</a> ‚Äî ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏†‡∏≤‡∏©‡∏µ Stage 3 Tax Cuts</div>
                <div>‚Ä¢ <a href="https://www.numbeo.com/cost-of-living/country_result.jsp?country=Australia" target="_blank" rel="noopener noreferrer" className="underline">Numbeo</a> ‚Äî ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏£‡∏≠‡∏á‡∏ä‡∏µ‡∏û ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏°‡∏∑‡∏≠‡∏á</div>
                <div>‚Ä¢ <a href="https://www.fairwork.gov.au/pay-and-wages/minimum-wages" target="_blank" rel="noopener noreferrer" className="underline">Fair Work Ombudsman</a> ‚Äî ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ $24.95/hr (1 Jul 2025)</div>
                <div>‚Ä¢ <a href="https://www.seek.com.au/career-advice/role" target="_blank" rel="noopener noreferrer" className="underline">SEEK Salary Guide</a> ‚Äî ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</div>
              </div>
            </div>
            <div className="mt-2 bg-amber-50 border border-amber-200 rounded-xl p-3">
              <div className="text-xs text-amber-700">
                ‚ö†Ô∏è <strong>‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</strong> ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏≠‡∏≤‡∏à‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ
                ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô‡πÑ‡∏î‡πâ ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏à‡∏≤‡∏Å <a href="https://www.xe.com/currencyconverter/convert/?Amount=1&From=AUD&To=THB" target="_blank" rel="noopener noreferrer" className="underline font-medium">XE.com</a> ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ Migration Agent ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡πà‡∏ô‡∏ß‡∏µ‡∏ã‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á
              </div>
            </div>

            {/* Link to detailed calculator */}
            <a href={`${basePath}/visa`} className="block mt-3 py-3 rounded-xl bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 text-center text-sm text-orange-700 font-medium hover:shadow-md transition-all">
              üìã ‡∏î‡∏π‡∏ß‡∏µ‡∏ã‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î & ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‚Üí
            </a>

            <div className="flex gap-2 mt-3 mb-2">
              <button onClick={() => setPhase('countryResults')} className="flex-1 py-3 rounded-xl border-2 border-gray-200 text-gray-500 hover:bg-gray-50 text-sm font-medium">
                ‚Üê ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡∏≠‡∏∑‡πà‡∏ô
              </button>
              <button onClick={restart} className="flex-1 py-3 rounded-xl border-2 border-blue-200 text-blue-600 hover:bg-blue-50 text-sm font-medium">
                üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
              </button>
            </div>
            <div className="mb-4">
              <ShareButtons />
            </div>
          </div>
        )}
        <div ref={bottomRef} />
      </div>
    </div>
  )
}

// ===== SUB-COMPONENTS =====
function BotMsg({ children }: { children: React.ReactNode }) {
  return (
    <div className="chat-bubble bot animate-fade-in">
      <span className="bot-avatar">üê±</span>
      <div className="bubble-content">{children}</div>
    </div>
  )
}

function UserMsg({ children }: { children: React.ReactNode }) {
  return (
    <div className="chat-bubble user animate-fade-in">
      <div className="bubble-content">{children}</div>
    </div>
  )
}

function Completed({ emoji, title, detail, negative }: { emoji: string; title: string; detail: string; negative?: boolean }) {
  return (
    <div className="completed-stage">
      <span className="text-base">{emoji}</span>
      <div className="min-w-0 flex-1">
        <span className="font-semibold text-gray-700 text-sm">{title}</span>
        <span className={`text-xs ml-2 ${negative ? 'text-red-500' : 'text-gray-500'}`}>{detail}</span>
      </div>
      <span className="text-green-500 text-xs">‚úì</span>
    </div>
  )
}

function Opt({ onClick, children }: { onClick: () => void; children: React.ReactNode }) {
  return <button onClick={onClick} className="stage-option-btn">{children}</button>
}

function SumRow({ label, aud }: { label: string; aud: number }) {
  return (
    <div className="flex justify-between py-1.5 text-sm border-b border-gray-100">
      <span>{label}</span>
      <div className="text-right">
        <span className="font-mono text-red-500">{aud > 0 ? `-${fmtAud(aud)}` : '$0'}</span>
        {aud > 0 && <div className="text-[10px] text-gray-400">({fmtThb(Math.round(aud * AUD_TO_THB))})</div>}
      </div>
    </div>
  )
}

function Row({ label, val, red, green }: { label: string; val: string; red?: boolean; green?: boolean }) {
  return (
    <div className="flex justify-between py-1 text-sm">
      <span className="text-gray-600">{label}</span>
      <span className={`font-mono ${red ? 'text-red-500' : green ? 'text-green-600' : 'text-gray-800'}`}>{val}</span>
    </div>
  )
}
